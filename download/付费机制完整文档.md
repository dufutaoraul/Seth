# èµ›æ–¯æ™ºæ…§ - ä»˜è´¹æœºåˆ¶å®Œæ•´æ–‡æ¡£

> æ›´æ–°æ—¶é—´ï¼š2025-09-30
> é€‚ç”¨å¹³å°ï¼šå°ç¨‹åºç«¯ + ç½‘é¡µç«¯é€šç”¨
> ä½œè€…ï¼šèµ›æ–¯æ™ºæ…§å›¢é˜Ÿ

---

## ğŸ“‹ ç›®å½•

1. [ä¸šåŠ¡æ¨¡å¼æ¦‚è¿°](#ä¸šåŠ¡æ¨¡å¼æ¦‚è¿°)
2. [ä¼šå‘˜ç­‰çº§ä½“ç³»](#ä¼šå‘˜ç­‰çº§ä½“ç³»)
3. [ä»˜è´¹å¥—é¤è¯¦æƒ…](#ä»˜è´¹å¥—é¤è¯¦æƒ…)
4. [ç§¯åˆ†ç³»ç»Ÿè§„åˆ™](#ç§¯åˆ†ç³»ç»Ÿè§„åˆ™)
5. [ç»­è´¹ä¸å‡çº§é€»è¾‘](#ç»­è´¹ä¸å‡çº§é€»è¾‘)
6. [æ”¯ä»˜æµç¨‹](#æ”¯ä»˜æµç¨‹)
7. [é€€æ¬¾æœºåˆ¶](#é€€æ¬¾æœºåˆ¶)
8. [æŠ€æœ¯å®ç°è¦ç‚¹](#æŠ€æœ¯å®ç°è¦ç‚¹)
9. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
10. [APIæ¥å£è§„èŒƒ](#apiæ¥å£è§„èŒƒ)

---

## ğŸ¯ ä¸šåŠ¡æ¨¡å¼æ¦‚è¿°

### æ ¸å¿ƒå®šä½
- **äº§å“å½¢æ€**ï¼šAIæ™ºèƒ½å¯¹è¯å¹³å°ï¼ˆå“²å­¦å¯¼å¸ˆèµ›æ–¯ï¼‰
- **ä»˜è´¹æ¨¡å¼**ï¼šç§¯åˆ†åˆ¶ä¼šå‘˜ä»˜è´¹
- **è®¡è´¹æ–¹å¼**ï¼šæŒ‰æ¶ˆæ¯æ•°è®¡è´¹ï¼ˆç”¨æˆ·å‘é€1æ¡æ¶ˆæ¯ = æ¶ˆè€—1ç§¯åˆ†ï¼‰
- **AIå›å¤**ï¼šä¸æ¶ˆè€—ç”¨æˆ·ç§¯åˆ†

### å•†ä¸šé€»è¾‘
- å…è´¹ç”¨æˆ·è·å¾—15æ¡ç»ˆèº«ä¸€æ¬¡æ€§æ¶ˆæ¯é¢åº¦ï¼Œç”¨å®Œåå¿…é¡»ä»˜è´¹
- ä»˜è´¹ç”¨æˆ·è´­ä¹°ç§¯åˆ†åŒ…ï¼Œè·å¾—å¯¹åº”æ•°é‡çš„æ¶ˆæ¯ç§¯åˆ†å’Œ30å¤©ä¼šå‘˜æœ‰æ•ˆæœŸ
- ç§¯åˆ†å¯å åŠ ï¼Œä½†æœ‰æ•ˆæœŸä¼šé‡ç½®ï¼ˆæ¯æ¬¡è´­ä¹°é‡æ–°è®¡ç®—30å¤©ï¼‰
- ç§¯åˆ†è¿‡æœŸåè‡ªåŠ¨é™çº§ä¸ºå…è´¹ç”¨æˆ·

---

## ğŸ‘¥ ä¼šå‘˜ç­‰çº§ä½“ç³»

### 1. å…è´¹ç”¨æˆ·ï¼ˆFreeï¼‰
**æ ‡è¯†**ï¼š`userType: 'free'`

**æƒç›Š**ï¼š
- æ¶ˆæ¯ç§¯åˆ†ï¼š15æ¡ï¼ˆç»ˆèº«ä¸€æ¬¡æ€§ï¼Œç”¨å®Œä¸å¯æ¢å¤ï¼‰
- æœ€å¤§å¯¹è¯æ•°ï¼š3ä¸ª
- æ¯æ—¥æ¶ˆæ¯ä¸Šé™ï¼š10æ¡
- åŠŸèƒ½æƒé™ï¼š
  - âœ… åŸºç¡€å¯¹è¯
  - âœ… å†å²è®°å½•
  - âŒ é«˜çº§æ€ç»´å¼•å¯¼
  - âŒ ä¼˜å…ˆå“åº”

**é™åˆ¶**ï¼š
- 15æ¡ç”¨å®Œåå¿…é¡»è´­ä¹°ç§¯åˆ†åŒ…æ‰èƒ½ç»§ç»­ä½¿ç”¨
- æ— æ³•è´­ä¹°ç§¯åˆ†è¡¥å……åŒ…ï¼ˆå¿…é¡»å…ˆè´­ä¹°ä¼šå‘˜å¥—é¤ï¼‰

---

### 2. æ ‡å‡†ä¼šå‘˜ï¼ˆStandardï¼‰
**æ ‡è¯†**ï¼š`userType: 'standard'`

**æƒç›Š**ï¼š
- æ¶ˆæ¯ç§¯åˆ†ï¼š150æ¡/æœˆ
- æœ€å¤§å¯¹è¯æ•°ï¼š20ä¸ª
- æ¯æ—¥æ¶ˆæ¯ä¸Šé™ï¼š100æ¡
- åŠŸèƒ½æƒé™ï¼š
  - âœ… åŸºç¡€å¯¹è¯
  - âœ… å†å²è®°å½•
  - âœ… é«˜çº§æ€ç»´å¼•å¯¼
  - âœ… ä¼˜å…ˆå“åº”
  - âŒ ç§äººå®šåˆ¶å¯¹è¯
  - âŒ æ·±åº¦å“²å­¦æ¢ç´¢

**ç‰¹ç‚¹**ï¼š
- æ€§ä»·æ¯”é«˜ï¼Œé€‚åˆè½»åº¦ç”¨æˆ·
- å¯åœ¨ä¼šå‘˜æœ‰æ•ˆæœŸå†…å‡çº§åˆ°é«˜çº§ä¼šå‘˜
- å¯è´­ä¹°ç§¯åˆ†è¡¥å……åŒ…å åŠ ç§¯åˆ†

---

### 3. é«˜çº§ä¼šå‘˜ï¼ˆPremiumï¼‰
**æ ‡è¯†**ï¼š`userType: 'premium'`

**æƒç›Š**ï¼š
- æ¶ˆæ¯ç§¯åˆ†ï¼š500æ¡/æœˆ
- æœ€å¤§å¯¹è¯æ•°ï¼šæ— é™åˆ¶
- æ¯æ—¥æ¶ˆæ¯ä¸Šé™ï¼šæ— é™åˆ¶
- åŠŸèƒ½æƒé™ï¼š
  - âœ… åŸºç¡€å¯¹è¯
  - âœ… å†å²è®°å½•
  - âœ… é«˜çº§æ€ç»´å¼•å¯¼
  - âœ… ä¼˜å…ˆå“åº”
  - âœ… ç§äººå®šåˆ¶å¯¹è¯
  - âœ… æ·±åº¦å“²å­¦æ¢ç´¢

**ç‰¹ç‚¹**ï¼š
- å¤§å®¹é‡ï¼Œé€‚åˆé‡åº¦ç”¨æˆ·
- æ— é™åˆ¶å¯¹è¯æ•°å’Œæ¯æ—¥æ¶ˆæ¯æ•°
- å¯è´­ä¹°ç§¯åˆ†è¡¥å……åŒ…å åŠ ç§¯åˆ†

---

## ğŸ’° ä»˜è´¹å¥—é¤è¯¦æƒ…

### å¥—é¤ç±»å‹å¯¹ç…§è¡¨

| å¥—é¤ID | å¥—é¤åç§° | ä»·æ ¼ | ç§¯åˆ†æ•° | æœ‰æ•ˆæœŸ | ä¼šå‘˜ç­‰çº§ | æ˜¯å¦å»¶æœŸ |
|--------|---------|------|--------|--------|----------|----------|
| `standard` | æ ‡å‡†ä¼šå‘˜ | Â¥145 | 150æ¡ | 30å¤© | standard | âœ… æ˜¯ |
| `premium` | é«˜çº§ä¼šå‘˜ | Â¥360 | 500æ¡ | 30å¤© | premium | âœ… æ˜¯ |
| `upgrade_to_premium` | æœ¬æœŸå‡çº§åˆ°é«˜çº§ | Â¥215 | 350æ¡ | - | premium | âŒ å¦ |
| `credits150` | ç§¯åˆ†è¡¥å……åŒ…150 | Â¥145 | 150æ¡ | - | ä¸å˜ | âŒ å¦ |
| `credits500` | ç§¯åˆ†è¡¥å……åŒ…500 | Â¥360 | 500æ¡ | - | ä¸å˜ | âŒ å¦ |

---

### 1ï¸âƒ£ æ ‡å‡†ä¼šå‘˜å¥—é¤
```json
{
  "id": "standard",
  "type": "standard",
  "title": "æ ‡å‡†ä¼šå‘˜",
  "price": 145,
  "originalPrice": null,
  "credits": 150,
  "validDays": 30,
  "features": [
    "150æ¡æ¶ˆæ¯ç§¯åˆ†",
    "1ä¸ªæœˆæœ‰æ•ˆæœŸ",
    "ç§¯åˆ†å¯å åŠ ",
    "æ™ºèƒ½å¯¹è¯ä½“éªŒ",
    "å®Œæ•´å†å²è®°å½•"
  ]
}
```

**è´­ä¹°æ•ˆæœ**ï¼š
- ç§¯åˆ†ï¼šå½“å‰ç§¯åˆ† + 150
- æœ‰æ•ˆæœŸï¼šä»è´­ä¹°æ—¥èµ·é‡æ–°è®¡ç®—30å¤©ï¼ˆé¡ºå»¶1ä¸ªæœˆï¼‰
- ä¼šå‘˜ç­‰çº§ï¼šå‡çº§ä¸º `standard`

**é€‚ç”¨äººç¾¤**ï¼š
- é¦–æ¬¡ä»˜è´¹ç”¨æˆ·
- è½»åº¦ä½¿ç”¨ç”¨æˆ·
- é¢„ç®—æœ‰é™ç”¨æˆ·

---

### 2ï¸âƒ£ é«˜çº§ä¼šå‘˜å¥—é¤
```json
{
  "id": "premium",
  "type": "premium",
  "title": "é«˜çº§ä¼šå‘˜",
  "price": 360,
  "originalPrice": 400,
  "credits": 500,
  "validDays": 30,
  "features": [
    "500æ¡æ¶ˆæ¯ç§¯åˆ†",
    "1ä¸ªæœˆæœ‰æ•ˆæœŸ",
    "ç§¯åˆ†å¯å åŠ ",
    "æ·±åº¦å“²å­¦æ¢ç´¢",
    "ä¼˜å…ˆå“åº”é€Ÿåº¦",
    "ä¸ªæ€§åŒ–å¼•å¯¼"
  ],
  "popular": true
}
```

**è´­ä¹°æ•ˆæœ**ï¼š
- ç§¯åˆ†ï¼šå½“å‰ç§¯åˆ† + 500
- æœ‰æ•ˆæœŸï¼šä»è´­ä¹°æ—¥èµ·é‡æ–°è®¡ç®—30å¤©ï¼ˆé¡ºå»¶1ä¸ªæœˆï¼‰
- ä¼šå‘˜ç­‰çº§ï¼šå‡çº§ä¸º `premium`

**é€‚ç”¨äººç¾¤**ï¼š
- é‡åº¦ä½¿ç”¨ç”¨æˆ·
- è¿½æ±‚æ€§ä»·æ¯”ç”¨æˆ·
- éœ€è¦æ·±åº¦æ¢ç´¢ç”¨æˆ·

**ä»·æ ¼ä¼˜åŠ¿**ï¼š
- æ ‡æ³¨"çœÂ¥40"ï¼ˆç›¸æ¯”è´­ä¹°3æ¬¡æ ‡å‡†ä¼šå‘˜ï¼‰
- å•æ¡æ¶ˆæ¯æˆæœ¬ï¼šÂ¥0.72/æ¡ï¼ˆæ ‡å‡†ï¼šÂ¥0.97/æ¡ï¼‰

---

### 3ï¸âƒ£ æœ¬æœŸå‡çº§åˆ°é«˜çº§ä¼šå‘˜
```json
{
  "id": "upgrade_to_premium",
  "type": "upgrade",
  "title": "å‡çº§åˆ°é«˜çº§ä¼šå‘˜ï¼ˆæœ¬æœŸï¼‰",
  "price": 215,
  "credits": 350,
  "validDays": 0
}
```

**è´­ä¹°æ¡ä»¶**ï¼š
- å½“å‰ä¸ºæ ‡å‡†ä¼šå‘˜ï¼ˆ`userType: 'standard'`ï¼‰
- ä¼šå‘˜æœ‰æ•ˆæœŸå†…ï¼ˆ`creditsExpireDate > å½“å‰æ—¶é—´`ï¼‰

**è´­ä¹°æ•ˆæœ**ï¼š
- ç§¯åˆ†ï¼šå½“å‰ç§¯åˆ† + 350ï¼ˆè¡¥å·®é¢è‡³500ï¼‰
- æœ‰æ•ˆæœŸï¼š**ä¸æ”¹å˜**ï¼ˆä¿æŒåŸåˆ°æœŸæ—¶é—´ï¼‰
- ä¼šå‘˜ç­‰çº§ï¼šå‡çº§ä¸º `premium`

**ä»·æ ¼è®¡ç®—**ï¼š
- è¡¥å·®ä»·ï¼šÂ¥360 - Â¥145 = Â¥215

**é€‚ç”¨åœºæ™¯**ï¼š
- æ ‡å‡†ä¼šå‘˜å‘ç°150æ¡ä¸å¤Ÿç”¨
- æƒ³è¦äº«å—é«˜çº§ä¼šå‘˜æƒç›Š
- ä¸æƒ³æµªè´¹å‰©ä½™å¤©æ•°

---

### 4ï¸âƒ£ ç§¯åˆ†è¡¥å……åŒ…

#### ç§¯åˆ†åŒ…150
```json
{
  "id": "credits150",
  "type": "credits",
  "title": "ç§¯åˆ†è¡¥å……åŒ…",
  "subtitle": "150ç§¯åˆ†",
  "price": 145,
  "credits": 150
}
```

#### ç§¯åˆ†åŒ…500
```json
{
  "id": "credits500",
  "type": "credits",
  "title": "ç§¯åˆ†è¡¥å……åŒ…",
  "subtitle": "500ç§¯åˆ†",
  "price": 360,
  "credits": 500
}
```

**è´­ä¹°æ¡ä»¶**ï¼š
- å¿…é¡»æ˜¯ä¼šå‘˜ï¼ˆ`userType: 'standard'` æˆ– `'premium'`ï¼‰
- ä¼šå‘˜æœ‰æ•ˆæœŸå†…ï¼ˆ`creditsExpireDate > å½“å‰æ—¶é—´`ï¼‰

**è´­ä¹°æ•ˆæœ**ï¼š
- ç§¯åˆ†ï¼šå½“å‰ç§¯åˆ† + å¯¹åº”æ•°é‡
- æœ‰æ•ˆæœŸï¼š**ä¸æ”¹å˜**ï¼ˆä¿æŒåŸåˆ°æœŸæ—¶é—´ï¼‰
- ä¼šå‘˜ç­‰çº§ï¼š**ä¸æ”¹å˜**

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¼šå‘˜æœ‰æ•ˆæœŸå†…ç§¯åˆ†ç”¨å®Œ
- éœ€è¦æ›´å¤šå¯¹è¯æ¬¡æ•°
- ä¸æƒ³é‡ç½®æœ‰æ•ˆæœŸ

---

## ğŸ”„ ç§¯åˆ†ç³»ç»Ÿè§„åˆ™

### ç§¯åˆ†è·å–

#### 1. æ³¨å†Œèµ é€
- æ–°ç”¨æˆ·æ³¨å†Œï¼š15æ¡æ¶ˆæ¯ç§¯åˆ†ï¼ˆç»ˆèº«ä¸€æ¬¡æ€§ï¼‰
- ç§¯åˆ†æ°¸ä¹…æœ‰æ•ˆï¼ˆä¸è¿‡æœŸï¼‰
- ç”¨å®Œåæ— æ³•æ¢å¤ï¼Œå¿…é¡»ä»˜è´¹è´­ä¹°

#### 2. è´­ä¹°è·å¾—
- é€šè¿‡å¾®ä¿¡æ”¯ä»˜è´­ä¹°ç§¯åˆ†åŒ…
- ç§¯åˆ†ç«‹å³åˆ°è´¦
- å¯å åŠ ç´¯è®¡

---

### ç§¯åˆ†æ¶ˆè€—

#### è®¡è´¹è§„åˆ™
- **ç”¨æˆ·å‘é€1æ¡æ¶ˆæ¯** = æ¶ˆè€—1ç§¯åˆ†
- **AIå›å¤** = ä¸æ¶ˆè€—ç§¯åˆ†
- **æ‰£è´¹æ—¶æœº**ï¼šæ¶ˆæ¯å‘é€æˆåŠŸåç«‹å³æ‰£å‡

#### æ‰£è´¹æµç¨‹
```javascript
// 1. æ£€æŸ¥ç§¯åˆ†ä½™é¢
if (user.messageCredits <= 0) {
  return { code: 402, message: 'INSUFFICIENT_CREDITS' }
}

// 2. æ£€æŸ¥ä¼šå‘˜æœ‰æ•ˆæœŸ
const isMemberValid = user.creditsExpireDate && 
  new Date(user.creditsExpireDate) > new Date()
if (!isMemberValid && user.userType !== 'free') {
  // ç§¯åˆ†å·²è¿‡æœŸï¼Œè‡ªåŠ¨é™çº§ä¸ºå…è´¹ç”¨æˆ·
  user.userType = 'free'
  user.messageCredits = 15
  user.creditsExpireDate = null
}

// 3. å‘é€æ¶ˆæ¯

// 4. æ‰£å‡ç§¯åˆ†
await db.collection('users').doc(user._id).update({
  messageCredits: user.messageCredits - 1
})
```

#### ä½™é¢ä¸è¶³å¤„ç†
- æç¤ºç”¨æˆ·ç§¯åˆ†ä¸è¶³
- å¼•å¯¼ç”¨æˆ·å‰å¾€ä¼šå‘˜ä¸­å¿ƒå……å€¼
- ç¦æ­¢å‘é€æ¶ˆæ¯

---

### ç§¯åˆ†è¿‡æœŸ

#### è¿‡æœŸè§„åˆ™
- **è¿‡æœŸæ—¶é—´**ï¼šæœ€åè´­ä¹°æ—¥èµ·30å¤©
- **è¿‡æœŸå­—æ®µ**ï¼š`creditsExpireDate`ï¼ˆISO 8601æ ¼å¼ï¼‰
- **è®¡ç®—æ–¹å¼**ï¼šæ¯æ¬¡è´­ä¹°ä¼šå‘˜å¥—é¤æ—¶é‡æ–°è®¡ç®—

#### è¿‡æœŸå¤„ç†é€»è¾‘
```javascript
// æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¿‡æœŸ
const now = new Date()
const expireDate = new Date(user.creditsExpireDate)

if (expireDate <= now) {
  // ç§¯åˆ†å·²è¿‡æœŸï¼Œæ‰§è¡Œé™çº§
  await db.collection('users').doc(user._id).update({
    userType: 'free',
    messageCredits: 15,
    creditsExpireDate: null,
    vipExpiredAt: null
  })
}
```

#### è¿‡æœŸåå¤„ç†
- æ‰€æœ‰ç§¯åˆ†æ¸…é›¶
- è‡ªåŠ¨é™çº§ä¸ºå…è´¹ç”¨æˆ·
- æ¢å¤15æ¡å…è´¹æ¶ˆæ¯é¢åº¦
- ä¼šå‘˜æƒç›Šå…¨éƒ¨å¤±æ•ˆ

---

### ç§¯åˆ†å åŠ è§„åˆ™

#### ä¼šå‘˜å¥—é¤è´­ä¹°ï¼ˆå»¶é•¿æœ‰æ•ˆæœŸï¼‰
```javascript
// æ ‡å‡†ä¼šå‘˜ç»­è´¹ç¤ºä¾‹
å½“å‰çŠ¶æ€ï¼š
  - ç§¯åˆ†ï¼š50æ¡
  - åˆ°æœŸï¼š2025-10-15 14:30:00
  
è´­ä¹°æ ‡å‡†ä¼šå‘˜ï¼ˆÂ¥145ï¼‰ï¼š
  - ç§¯åˆ†ï¼š50 + 150 = 200æ¡
  - åˆ°æœŸï¼š2025-11-15 14:30:00ï¼ˆé¡ºå»¶1ä¸ªæœˆï¼‰
```

#### ç§¯åˆ†è¡¥å……åŒ…è´­ä¹°ï¼ˆä¸å»¶é•¿æœ‰æ•ˆæœŸï¼‰
```javascript
// ç§¯åˆ†åŒ…è´­ä¹°ç¤ºä¾‹
å½“å‰çŠ¶æ€ï¼š
  - ç§¯åˆ†ï¼š30æ¡
  - åˆ°æœŸï¼š2025-10-15 14:30:00
  
è´­ä¹°ç§¯åˆ†åŒ…150ï¼ˆÂ¥145ï¼‰ï¼š
  - ç§¯åˆ†ï¼š30 + 150 = 180æ¡
  - åˆ°æœŸï¼š2025-10-15 14:30:00ï¼ˆä¸å˜ï¼‰
```

---

## ğŸ”„ ç»­è´¹ä¸å‡çº§é€»è¾‘

### ç»­è´¹çª—å£è§„åˆ™

#### ç»­è´¹æ—¶æœº
- **ç«‹å³å¯ç»­è´¹æƒ…å†µ**ï¼š
  1. ä¼šå‘˜å·²è¿‡æœŸï¼ˆ`creditsExpireDate <= å½“å‰æ—¶é—´`ï¼‰
  2. è·ç¦»åˆ°æœŸä¸è¶³3å¤©ï¼ˆ`å‰©ä½™å¤©æ•° <= 3`ï¼‰
  3. è°ƒè¯•æ¨¡å¼å¼ºåˆ¶å¼€å¯ç»­è´¹çª—å£ï¼ˆ`forceRenew = true`ï¼‰

- **ä¸å¯ç»­è´¹æƒ…å†µ**ï¼š
  1. è·ç¦»åˆ°æœŸè¶…è¿‡3å¤©
  2. æç¤ºï¼š"æœ¬æœŸä¼šå‘˜å·²ç”Ÿæ•ˆï¼Œä¸´è¿‘åˆ°æœŸæˆ–åˆ°æœŸåå¯ç»­è´¹"

#### ç»­è´¹æŒ‰é’®çŠ¶æ€
```javascript
// è®¡ç®—æ˜¯å¦å¯ä»¥ç»­è´¹
function canRenewMember(vipExpiredAt) {
  if (!vipExpiredAt) return true // å…è´¹ç”¨æˆ·å¯è´­ä¹°
  
  const now = new Date()
  const exp = new Date(vipExpiredAt)
  const diffDays = Math.ceil((exp - now) / (24 * 60 * 60 * 1000))
  
  const forceRenew = getStorageSync('forceRenewMember') || false
  const isMemberExpired = exp <= now
  
  return forceRenew || isMemberExpired || diffDays <= 3
}
```

---

### å‡çº§é€»è¾‘

#### æ ‡å‡†ä¼šå‘˜å‡çº§åˆ°é«˜çº§ä¼šå‘˜

**æ–¹å¼ä¸€ï¼šæœ¬æœŸå‡çº§ï¼ˆæ¨èï¼‰**
- **ä»·æ ¼**ï¼šÂ¥215ï¼ˆè¡¥å·®ä»·ï¼‰
- **ç§¯åˆ†å˜åŒ–**ï¼šå½“å‰ç§¯åˆ† + 350
- **æœ‰æ•ˆæœŸ**ï¼šä¸æ”¹å˜
- **ç­‰çº§**ï¼šstandard â†’ premium

**è§¦å‘æ¡ä»¶**ï¼š
```javascript
// æ˜¾ç¤º"å‡çº§åˆ°é«˜çº§"æŒ‰é’®çš„æ¡ä»¶
const canUpgradeToPremium = 
  currentTier === 'standard' && // å½“å‰æ˜¯æ ‡å‡†ä¼šå‘˜
  !isMemberExpired // ä¼šå‘˜æœ‰æ•ˆæœŸå†…
```

**å‡çº§æµç¨‹**ï¼š
```javascript
// 1. æ£€æŸ¥èµ„æ ¼
if (currentTier !== 'standard' || isMemberExpired) {
  return { message: 'ä»…æ ‡å‡†ä¼šå‘˜æœ‰æ•ˆæœŸå†…å¯å‡çº§' }
}

// 2. åˆ›å»ºå‡çº§è®¢å•
const order = {
  productType: 'upgrade_to_premium',
  amount: 21500, // 215å…ƒï¼ˆå•ä½ï¼šåˆ†ï¼‰
  credits: 350
}

// 3. æ”¯ä»˜æˆåŠŸåå…¥è´¦
await db.collection('users').doc(userId).update({
  messageCredits: user.messageCredits + 350,
  userType: 'premium',
  // creditsExpireDate ä¿æŒä¸å˜
})
```

---

**æ–¹å¼äºŒï¼šä¸‹æœŸç»­è´¹æ—¶é€‰æ‹©é«˜çº§ä¼šå‘˜**
- **ä»·æ ¼**ï¼šÂ¥360
- **ç§¯åˆ†å˜åŒ–**ï¼šå½“å‰ç§¯åˆ† + 500
- **æœ‰æ•ˆæœŸ**ï¼šé‡æ–°è®¡ç®—30å¤©
- **ç­‰çº§**ï¼šstandard â†’ premium

**é€‚ç”¨åœºæ™¯**ï¼š
- å½“å‰ä¼šå‘˜å³å°†åˆ°æœŸï¼ˆ<=3å¤©ï¼‰
- å¸Œæœ›è·å¾—æ›´å¤šç§¯åˆ†
- æ¥å—é‡ç½®æœ‰æ•ˆæœŸ

---

### é™çº§é€»è¾‘

#### è‡ªåŠ¨é™çº§è§¦å‘æ¡ä»¶
1. ä¼šå‘˜åˆ°æœŸï¼ˆ`creditsExpireDate <= å½“å‰æ—¶é—´`ï¼‰
2. ç”¨æˆ·ç”³è¯·é€€æ¬¾ï¼ˆé€€æ¬¾æˆåŠŸåï¼‰

#### é™çº§å¤„ç†
```javascript
// ä¼šå‘˜åˆ°æœŸè‡ªåŠ¨é™çº§
await db.collection('users').doc(userId).update({
  userType: 'free',
  messageCredits: 15,
  creditsExpireDate: null,
  vipExpiredAt: null
})
```

---

## ğŸ’³ æ”¯ä»˜æµç¨‹

### ç”¨æˆ·ä¾§æµç¨‹

```
é€‰æ‹©å¥—é¤
   â†“
ç¡®è®¤è´­ä¹°ï¼ˆå¼¹çª—æ˜¾ç¤ºä»·æ ¼å’Œæƒç›Šï¼‰
   â†“
è°ƒèµ·å¾®ä¿¡æ”¯ä»˜
   â†“
è¾“å…¥å¯†ç /æŒ‡çº¹/é¢å®¹
   â†“
æ”¯ä»˜æˆåŠŸ â†’ ç§¯åˆ†ç«‹å³åˆ°è´¦
   â†“
æ˜¾ç¤ºè´­ä¹°æˆåŠŸæç¤º
```

---

### æŠ€æœ¯ä¾§æµç¨‹

#### 1. åˆ›å»ºæ”¯ä»˜è®¢å•
**å‰ç«¯è°ƒç”¨**ï¼š
```javascript
const result = await cloudApi.createPaymentOrder({ 
  productType: 'standard' // å¥—é¤ID
})
```

**äº‘å‡½æ•°å¤„ç†**ï¼š
```javascript
// cloudfunctions/wxpayFunctions/wxpay_order/index.js

// 1. æ ¹æ®äº§å“ç±»å‹è·å–ä»·æ ¼
const priceMap = {
  'standard': 14500,        // Â¥145
  'premium': 36000,         // Â¥360
  'upgrade_to_premium': 21500, // Â¥215
  'credits150': 14500,      // Â¥145
  'credits500': 36000       // Â¥360
}
const totalFee = priceMap[productType]

// 2. ç”Ÿæˆè®¢å•å·
const outTradeNo = `ORDER_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`

// 3. ä¿å­˜è®¢å•åˆ°æ•°æ®åº“
await db.collection('orders').add({
  data: {
    outTradeNo,
    openId: wxContext.OPENID,
    productType,
    amount: totalFee,
    status: 'pending',
    createdAt: db.serverDate()
  }
})

// 4. è°ƒç”¨å¾®ä¿¡æ”¯ä»˜ç»Ÿä¸€ä¸‹å•API
const paymentData = await wxpay.transactions.jsapi({
  description: `èµ›æ–¯æ™ºæ…§-${productTitle}`,
  out_trade_no: outTradeNo,
  amount: { total: totalFee, currency: 'CNY' },
  payer: { openid: wxContext.OPENID }
})

// 5. è¿”å›æ”¯ä»˜å‚æ•°
return {
  code: 0,
  data: {
    timeStamp: String(Date.now()),
    nonceStr: paymentData.nonce_str,
    package: `prepay_id=${paymentData.prepay_id}`,
    signType: 'RSA',
    paySign: paymentData.sign,
    orderId: outTradeNo
  }
}
```

---

#### 2. è°ƒèµ·å¾®ä¿¡æ”¯ä»˜
**å‰ç«¯è°ƒç”¨**ï¼š
```javascript
wx.requestPayment({
  timeStamp: paymentData.timeStamp,
  nonceStr: paymentData.nonceStr,
  package: paymentData.package,
  signType: paymentData.signType,
  paySign: paymentData.paySign,
  success: (res) => {
    console.log('æ”¯ä»˜æˆåŠŸ', res)
    // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
    loadUserInfo()
  },
  fail: (err) => {
    if (err.errMsg.includes('cancel')) {
      console.log('ç”¨æˆ·å–æ¶ˆæ”¯ä»˜')
    } else {
      console.error('æ”¯ä»˜å¤±è´¥', err)
    }
  }
})
```

---

#### 3. æ”¯ä»˜å›è°ƒå¤„ç†
**å¾®ä¿¡å›è°ƒ**ï¼š
```javascript
// cloudfunctions/payCallback/index.js

exports.main = async (event) => {
  // 1. éªŒè¯å›è°ƒç­¾åï¼ˆç¡®ä¿æ¥è‡ªå¾®ä¿¡ï¼‰
  
  // 2. ä»…å¤„ç†æ”¯ä»˜æˆåŠŸé€šçŸ¥
  if (event.event_type !== 'TRANSACTION.SUCCESS') {
    return { code: 0, message: 'IGNORED' }
  }
  
  // 3. æŸ¥è¯¢è®¢å•
  const order = await db.collection('orders')
    .where({ outTradeNo: event.resource.outTradeNo })
    .get()
  
  // 4. å¹‚ç­‰æ£€æŸ¥ï¼ˆé˜²æ­¢é‡å¤å…¥è´¦ï¼‰
  if (order.status === 'paid') {
    return { code: 0, message: 'SUCCESS' }
  }
  
  // 5. æ›´æ–°è®¢å•çŠ¶æ€
  await db.collection('orders').doc(order._id).update({
    status: 'paid',
    paidAt: db.serverDate(),
    wxTransactionId: event.resource.transactionId
  })
  
  // 6. ç§¯åˆ†å…¥è´¦
  const { credits, validMonths } = mapProductToCredits(order.productType)
  await creditAccountLogic(order.openId, credits, validMonths, order.productType)
  
  return { code: 0, message: 'SUCCESS' }
}
```

---

#### 4. ç§¯åˆ†å…¥è´¦é€»è¾‘
```javascript
/**
 * ç§¯åˆ†å…¥è´¦æ ¸å¿ƒé€»è¾‘
 */
async function creditAccountLogic(openId, credits, validMonths, productType) {
  const user = await db.collection('users').where({ _openid: openId }).get()
  const now = new Date()
  
  // æƒ…å†µ1ï¼šå‡çº§åˆ°é«˜çº§ä¼šå‘˜ï¼ˆæœ¬æœŸï¼‰
  if (productType === 'upgrade_to_premium') {
    // åªåŠ ç§¯åˆ†ï¼Œä¸æ”¹åˆ°æœŸï¼Œæ”¹ç­‰çº§
    await db.collection('users').doc(user._id).update({
      messageCredits: user.messageCredits + 350,
      userType: 'premium'
      // creditsExpireDate ä¸å˜
    })
    return
  }
  
  // æƒ…å†µ2ï¼šç§¯åˆ†è¡¥å……åŒ…
  if (productType === 'credits150' || productType === 'credits500') {
    // åªåŠ ç§¯åˆ†ï¼Œä¸æ”¹åˆ°æœŸï¼Œä¸æ”¹ç­‰çº§
    await db.collection('users').doc(user._id).update({
      messageCredits: user.messageCredits + credits
      // creditsExpireDate ä¸å˜
      // userType ä¸å˜
    })
    return
  }
  
  // æƒ…å†µ3ï¼šä¼šå‘˜å¥—é¤ï¼ˆstandard/premiumï¼‰
  // åŠ ç§¯åˆ† + å»¶é•¿åˆ°æœŸ + æ”¹ç­‰çº§
  const currentExpire = user.creditsExpireDate ? 
    new Date(user.creditsExpireDate) : now
  const baseDate = currentExpire > now ? currentExpire : now
  const newExpire = addMonths(baseDate, validMonths)
  
  await db.collection('users').doc(user._id).update({
    messageCredits: user.messageCredits + credits,
    creditsExpireDate: newExpire,
    vipExpiredAt: newExpire,
    userType: productType // 'standard' or 'premium'
  })
}

/**
 * é¡ºå»¶æœˆä»½ï¼ˆå¤„ç†æœˆæœ«è¾¹ç•Œæƒ…å†µï¼‰
 */
function addMonths(baseDate, months) {
  const d = new Date(baseDate)
  const year = d.getFullYear()
  const month = d.getMonth() + months
  const day = d.getDate()
  
  // è®¡ç®—ç›®æ ‡æœˆæœ€åä¸€å¤©
  const lastDayOfTargetMonth = new Date(year, month + 1, 0).getDate()
  const targetDay = Math.min(day, lastDayOfTargetMonth)
  
  return new Date(year, month, targetDay, 
    d.getHours(), d.getMinutes(), d.getSeconds())
}
```

---

#### 5. å…œåº•è½®è¯¢æœºåˆ¶
ä¸ºé˜²æ­¢æ”¯ä»˜æˆåŠŸä½†å›è°ƒå¤±è´¥å¯¼è‡´ç§¯åˆ†æœªåˆ°è´¦ï¼Œå‰ç«¯ä¼šå¯åŠ¨è½®è¯¢æ£€æŸ¥ï¼š

```javascript
// å‰ç«¯è½®è¯¢é€»è¾‘
async function startBalanceEnsurePolling(expectedIncrease, orderId) {
  const prePurchaseCredits = currentCredits
  const schedule = [2000, 6000, 12000] // 2s, 8s, 20såæ£€æŸ¥
  
  for (let i = 0; i < schedule.length; i++) {
    await sleep(schedule[i] - (schedule[i-1] || 0))
    
    // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
    await loadUserInfo()
    
    const increased = currentCredits - prePurchaseCredits
    if (increased >= expectedIncrease) {
      showToast('ç§¯åˆ†å·²åˆ°è´¦')
      return
    }
  }
  
  // è½®è¯¢ç»“æŸä»æœªåˆ°è´¦ï¼Œè°ƒç”¨æœåŠ¡ç«¯å…œåº•å¯¹è´¦
  await wx.cloud.callFunction({
    name: 'reconcileOrder',
    data: { outTradeNo: orderId }
  })
}
```

---

## ğŸ”™ é€€æ¬¾æœºåˆ¶

### é€€æ¬¾æ”¿ç­–
- **é€€æ¬¾æœŸé™**ï¼šè´­ä¹°å7å¤©å†…
- **é€€æ¬¾æ¡ä»¶**ï¼šæœªä½¿ç”¨æˆ–ä½¿ç”¨ä¸è¶³10%
- **é€€æ¬¾æ–¹å¼**ï¼šåŸè·¯é€€å›å¾®ä¿¡æ”¯ä»˜è´¦æˆ·
- **åˆ°è´¦æ—¶é—´**ï¼š1-3ä¸ªå·¥ä½œæ—¥

---

### é€€æ¬¾æµç¨‹

#### 1. ç”¨æˆ·ç”³è¯·é€€æ¬¾
```
ç”¨æˆ·è”ç³»å®¢æœ
   â†“
å®¢æœå®¡æ ¸èµ„æ ¼ï¼ˆè´­ä¹°æ—¶é—´ã€ä½¿ç”¨æƒ…å†µï¼‰
   â†“
å®¢æœåœ¨ç®¡ç†åå°å‘èµ·é€€æ¬¾
   â†“
å¾®ä¿¡æ”¯ä»˜å¤„ç†é€€æ¬¾
   â†“
é€€æ¬¾æˆåŠŸ â†’ æ‰£é™¤ç§¯åˆ† + é™çº§ä¼šå‘˜
```

---

#### 2. é€€æ¬¾æŠ€æœ¯å®ç°
```javascript
// å‘èµ·é€€æ¬¾
const result = await wx.cloud.callFunction({
  name: 'wxpayFunctions',
  data: {
    type: 'wxpay_refund',
    outTradeNo: 'ORDER_XXX',
    refundAmount: 14500,
    reason: 'ç”¨æˆ·ç”³è¯·é€€æ¬¾'
  }
})
```

---

#### 3. é€€æ¬¾å›è°ƒå¤„ç†
```javascript
// cloudfunctions/refundCallback/index.js

exports.main = async (event) => {
  // 1. éªŒè¯å›è°ƒç­¾å
  
  // 2. ä»…å¤„ç†é€€æ¬¾æˆåŠŸé€šçŸ¥
  if (event.event_type !== 'REFUND.SUCCESS') {
    return { code: 0, message: 'IGNORED' }
  }
  
  // 3. æŸ¥è¯¢è®¢å•
  const order = await db.collection('orders')
    .where({ outTradeNo: event.resource.outTradeNo })
    .get()
  
  // 4. æ›´æ–°è®¢å•çŠ¶æ€
  await db.collection('orders').doc(order._id).update({
    status: 'refunded',
    refundedAt: db.serverDate()
  })
  
  // 5. æ‰£é™¤ç§¯åˆ†å¹¶é™çº§
  const { credits } = mapProductToCredits(order.productType)
  const user = await db.collection('users')
    .where({ _openid: event.resource.openId })
    .get()
  
  await db.collection('users').doc(user._id).update({
    messageCredits: Math.max(0, user.messageCredits - credits),
    userType: 'free',
    creditsExpireDate: null,
    vipExpiredAt: null
  })
  
  return { code: 0, message: 'SUCCESS' }
}
```

---

## ğŸ› ï¸ æŠ€æœ¯å®ç°è¦ç‚¹

### å‰ç«¯å…³é”®ç‚¹

#### 1. ä¼šå‘˜çŠ¶æ€åˆ¤æ–­
```javascript
// åˆ¤æ–­ä¼šå‘˜æ˜¯å¦æœ‰æ•ˆ
function isMemberValid(user) {
  const expireDate = user.creditsExpireDate
  if (!expireDate) return false
  return new Date(expireDate) > new Date()
}

// åˆ¤æ–­æ˜¯å¦å¯ä»¥ç»­è´¹
function canRenew(user) {
  const expireDate = user.creditsExpireDate
  if (!expireDate) return true // å…è´¹ç”¨æˆ·å¯è´­ä¹°
  
  const now = new Date()
  const exp = new Date(expireDate)
  const diffMs = exp - now
  const diffDays = Math.ceil(diffMs / (24 * 60 * 60 * 1000))
  
  return diffDays <= 3 || exp <= now
}

// åˆ¤æ–­æ˜¯å¦å¯ä»¥å‡çº§åˆ°é«˜çº§
function canUpgrade(user) {
  return user.userType === 'standard' && isMemberValid(user)
}
```

---

#### 2. æŒ‰é’®çŠ¶æ€æ§åˆ¶
```javascript
// å¥—é¤é€‰æ‹©æŒ‰é’®çŠ¶æ€
function getPlanButtonState(plan, user) {
  // å‡çº§åˆ°é«˜çº§æŒ‰é’®
  if (plan.id === 'premium' && canUpgrade(user)) {
    return {
      text: 'å‡çº§é«˜çº§',
      disabled: false,
      action: 'upgrade'
    }
  }
  
  // ä¼šå‘˜å¥—é¤ç»­è´¹æŒ‰é’®
  if (plan.id === 'standard' || plan.id === 'premium') {
    if (!canRenew(user)) {
      return {
        text: 'å·²ç”Ÿæ•ˆ',
        disabled: true
      }
    }
    
    const isCurrentTier = user.userType === plan.type
    return {
      text: isCurrentTier ? 'ç»­è´¹' : 'é€‰æ‹©',
      disabled: false,
      action: 'purchase'
    }
  }
  
  // ç§¯åˆ†è¡¥å……åŒ…æŒ‰é’®
  if (plan.type === 'credits') {
    if (!isMemberValid(user)) {
      return {
        text: 'éœ€è¦ä¼šå‘˜',
        disabled: true
      }
    }
    return {
      text: 'è´­ä¹°',
      disabled: false,
      action: 'purchase'
    }
  }
}
```

---

#### 3. æ—¥æœŸæ ¼å¼åŒ–
```javascript
/**
 * æ ¼å¼åŒ–æ—¥æœŸ
 * @param {string|Date} date - æ—¥æœŸ
 * @param {number} format - 10:YYYY-MM-DD, 16:YYYY-MM-DD HH:mm
 */
function formatDate(date, format = 10) {
  const d = new Date(date)
  if (isNaN(d.getTime())) return 'â€”'
  
  const year = d.getFullYear()
  const month = String(d.getMonth() + 1).padStart(2, '0')
  const day = String(d.getDate()).padStart(2, '0')
  
  const base = `${year}-${month}-${day}`
  
  if (format === 16) {
    const hour = String(d.getHours()).padStart(2, '0')
    const minute = String(d.getMinutes()).padStart(2, '0')
    return `${base} ${hour}:${minute}`
  }
  
  return base
}
```

---

### åç«¯å…³é”®ç‚¹

#### 1. æ•°æ®åº“å­—æ®µè®¾è®¡
```javascript
// users é›†åˆå­—æ®µ
{
  _id: ObjectId,
  _openid: String,          // å¾®ä¿¡ç”¨æˆ·å”¯ä¸€æ ‡è¯†
  userType: String,         // ä¼šå‘˜ç±»å‹ï¼š'free' | 'standard' | 'premium'
  messageCredits: Number,   // å‰©ä½™æ¶ˆæ¯ç§¯åˆ†
  creditsExpireDate: Date,  // ç§¯åˆ†åˆ°æœŸæ—¶é—´
  vipExpiredAt: Date,       // ä¼šå‘˜åˆ°æœŸæ—¶é—´ï¼ˆå…¼å®¹å­—æ®µï¼‰
  lastPurchaseDate: Date,   // æœ€åè´­ä¹°æ—¶é—´
  createdAt: Date,          // æ³¨å†Œæ—¶é—´
  updatedAt: Date           // æ›´æ–°æ—¶é—´
}

// orders é›†åˆå­—æ®µ
{
  _id: ObjectId,
  openId: String,           // è´­ä¹°ç”¨æˆ·
  outTradeNo: String,       // å•†æˆ·è®¢å•å·
  wxTransactionId: String,  // å¾®ä¿¡æ”¯ä»˜è®¢å•å·
  productType: String,      // äº§å“ç±»å‹ï¼š'standard' | 'premium' | ...
  amount: Number,           // è®¢å•é‡‘é¢ï¼ˆå•ä½ï¼šåˆ†ï¼‰
  status: String,           // è®¢å•çŠ¶æ€ï¼š'pending' | 'paid' | 'refunded'
  createdAt: Date,          // åˆ›å»ºæ—¶é—´
  paidAt: Date,             // æ”¯ä»˜æ—¶é—´
  refundedAt: Date,         // é€€æ¬¾æ—¶é—´
  updatedAt: Date           // æ›´æ–°æ—¶é—´
}
```

---

#### 2. ç§¯åˆ†æ‰£å‡ï¼ˆæ¶ˆæ¯å‘é€æ—¶ï¼‰
```javascript
// cloudfunctions/sendMessage/index.js

async function quickCreditCheck(openId) {
  const db = cloud.database()
  const user = await db.collection('users')
    .where({ _openid: openId })
    .get()
  
  if (!user || user.data.length === 0) {
    return null
  }
  
  const userData = user.data[0]
  
  // æ£€æŸ¥ä¼šå‘˜æ˜¯å¦è¿‡æœŸ
  if (userData.creditsExpireDate) {
    const now = new Date()
    const expire = new Date(userData.creditsExpireDate)
    
    if (expire <= now && userData.userType !== 'free') {
      // ä¼šå‘˜å·²è¿‡æœŸï¼Œè‡ªåŠ¨é™çº§
      await db.collection('users').doc(userData._id).update({
        data: {
          userType: 'free',
          messageCredits: 15,
          creditsExpireDate: null,
          vipExpiredAt: null
        }
      })
      return { ...userData, messageCredits: 15, userType: 'free' }
    }
  }
  
  // æ£€æŸ¥ç§¯åˆ†ä½™é¢
  if (userData.messageCredits <= 0) {
    return null
  }
  
  return userData
}

async function deductCreditsAsync(openId, requestId) {
  const db = cloud.database()
  
  // ä½¿ç”¨åŸå­æ“ä½œæ‰£å‡ç§¯åˆ†
  await db.collection('users')
    .where({ _openid: openId })
    .update({
      data: {
        messageCredits: db.command.inc(-1)
      }
    })
  
  console.log('ç§¯åˆ†æ‰£å‡æˆåŠŸ:', { openId, requestId })
}
```

---

#### 3. å¹‚ç­‰æ€§ä¿éšœ
```javascript
/**
 * æ”¯ä»˜å›è°ƒå¹‚ç­‰æ€§æ£€æŸ¥
 */
async function handlePaymentCallback(orderNo) {
  const order = await db.collection('orders')
    .where({ outTradeNo: orderNo })
    .get()
  
  // è®¢å•å·²å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›æˆåŠŸ
  if (order.data[0].status === 'paid') {
    console.log('è®¢å•å·²å¤„ç†ï¼Œè·³è¿‡:', orderNo)
    return { code: 0, message: 'SUCCESS' }
  }
  
  // ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ç¡®ä¿åŸå­æ€§
  const transaction = await db.startTransaction()
  
  try {
    // 1. æ›´æ–°è®¢å•çŠ¶æ€
    await transaction.collection('orders')
      .doc(order.data[0]._id)
      .update({ status: 'paid' })
    
    // 2. ç§¯åˆ†å…¥è´¦
    await transaction.collection('users')
      .where({ _openid: order.data[0].openId })
      .update({ 
        messageCredits: db.command.inc(credits),
        creditsExpireDate: newExpireDate
      })
    
    // 3. æäº¤äº‹åŠ¡
    await transaction.commit()
    
    return { code: 0, message: 'SUCCESS' }
  } catch (error) {
    // å›æ»šäº‹åŠ¡
    await transaction.rollback()
    throw error
  }
}
```

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### users é›†åˆ
```javascript
{
  _id: "60a1b2c3d4e5f6g7h8i9j0k1",
  _openid: "oABCD1234567890",
  userType: "premium",
  messageCredits: 350,
  creditsExpireDate: "2025-10-30T14:30:00.000Z",
  vipExpiredAt: "2025-10-30T14:30:00.000Z",
  lastPurchaseDate: "2025-09-30T14:30:00.000Z",
  createdAt: "2025-08-01T10:00:00.000Z",
  updatedAt: "2025-09-30T14:30:00.000Z"
}
```

**å­—æ®µè¯´æ˜**ï¼š
- `_openid`ï¼šå¾®ä¿¡ç”¨æˆ·å”¯ä¸€æ ‡è¯†
- `userType`ï¼šä¼šå‘˜ç±»å‹ï¼ˆfree/standard/premiumï¼‰
- `messageCredits`ï¼šå‰©ä½™æ¶ˆæ¯ç§¯åˆ†æ•°
- `creditsExpireDate`ï¼šç§¯åˆ†åˆ°æœŸæ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰
- `vipExpiredAt`ï¼šä¼šå‘˜åˆ°æœŸæ—¶é—´ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
- `lastPurchaseDate`ï¼šæœ€åè´­ä¹°æ—¶é—´

---

### orders é›†åˆ
```javascript
{
  _id: "70a1b2c3d4e5f6g7h8i9j0k2",
  openId: "oABCD1234567890",
  outTradeNo: "ORDER_1727699400000_abc123xyz",
  wxTransactionId: "4200002312202509301234567890",
  productType: "premium",
  amount: 36000,
  status: "paid",
  createdAt: "2025-09-30T14:30:00.000Z",
  paidAt: "2025-09-30T14:35:00.000Z",
  updatedAt: "2025-09-30T14:35:00.000Z"
}
```

**å­—æ®µè¯´æ˜**ï¼š
- `openId`ï¼šè´­ä¹°ç”¨æˆ·çš„OpenID
- `outTradeNo`ï¼šå•†æˆ·è®¢å•å·ï¼ˆå”¯ä¸€ï¼‰
- `wxTransactionId`ï¼šå¾®ä¿¡æ”¯ä»˜äº¤æ˜“å·
- `productType`ï¼šäº§å“ç±»å‹ï¼ˆstandard/premium/upgrade_to_premium/credits150/credits500ï¼‰
- `amount`ï¼šè®¢å•é‡‘é¢ï¼ˆå•ä½ï¼šåˆ†ï¼‰
- `status`ï¼šè®¢å•çŠ¶æ€ï¼ˆpending/paid/refundedï¼‰

---

### conversations é›†åˆ
```javascript
{
  _id: "80a1b2c3d4e5f6g7h8i9j0k3",
  openId: "oABCD1234567890",
  title: "æ¢ç´¢æ„è¯†çš„æœ¬è´¨",
  createdAt: "2025-09-30T10:00:00.000Z",
  updatedAt: "2025-09-30T14:30:00.000Z"
}
```

---

### messages é›†åˆ
```javascript
{
  _id: "90a1b2c3d4e5f6g7h8i9j0k4",
  conversationId: "80a1b2c3d4e5f6g7h8i9j0k3",
  content: "ä»€ä¹ˆæ˜¯æ„è¯†ï¼Ÿ",
  isFromUser: true,
  isComplete: true,
  createdAt: "2025-09-30T14:30:00.000Z"
}
```

---

## ğŸ”Œ APIæ¥å£è§„èŒƒ

### 1. ç”¨æˆ·ç™»å½•/è·å–ä¿¡æ¯
**æ¥å£**ï¼š`cloudfunctions/login`

**è¯·æ±‚å‚æ•°**ï¼šæ— 

**è¿”å›æ•°æ®**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "_id": "60a1b2c3d4e5f6g7h8i9j0k1",
    "_openid": "oABCD1234567890",
    "userType": "premium",
    "messageCredits": 350,
    "creditsExpireDate": "2025-10-30T14:30:00.000Z",
    "vipExpiredAt": "2025-10-30T14:30:00.000Z"
  }
}
```

---

### 2. åˆ›å»ºæ”¯ä»˜è®¢å•
**æ¥å£**ï¼š`cloudfunctions/wxpayFunctions` (type: wxpay_order)

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "type": "wxpay_order",
  "productType": "premium"
}
```

**è¿”å›æ•°æ®**ï¼š
```json
{
  "code": 0,
  "data": {
    "timeStamp": "1727699400",
    "nonceStr": "abc123xyz",
    "package": "prepay_id=wx30143005678901234567890",
    "signType": "RSA",
    "paySign": "ABC123XYZ...",
    "orderId": "ORDER_1727699400000_abc123xyz"
  }
}
```

---

### 3. å‘é€æ¶ˆæ¯
**æ¥å£**ï¼š`cloudfunctions/sendMessage`

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "conversationId": "80a1b2c3d4e5f6g7h8i9j0k3",
  "message": "ä»€ä¹ˆæ˜¯æ„è¯†ï¼Ÿ",
  "streaming": true
}
```

**è¿”å›æ•°æ®**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "requestId": "req_abc123xyz",
    "messageId": "90a1b2c3d4e5f6g7h8i9j0k4"
  }
}
```

**é”™è¯¯ç **ï¼š
- `402`ï¼šç§¯åˆ†ä¸è¶³ï¼ˆINSUFFICIENT_CREDITSï¼‰
- `403`ï¼šä¼šå‘˜å·²è¿‡æœŸï¼ˆMEMBERSHIP_EXPIREDï¼‰

---

### 4. æŸ¥è¯¢è®¢å•
**æ¥å£**ï¼š`cloudfunctions/wxpayFunctions` (type: wxpay_query_order_by_out_trade_no)

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "type": "wxpay_query_order_by_out_trade_no",
  "outTradeNo": "ORDER_1727699400000_abc123xyz"
}
```

**è¿”å›æ•°æ®**ï¼š
```json
{
  "code": 0,
  "data": {
    "outTradeNo": "ORDER_1727699400000_abc123xyz",
    "transactionId": "4200002312202509301234567890",
    "tradeState": "SUCCESS",
    "amount": { "total": 36000, "currency": "CNY" },
    "payer": { "openid": "oABCD1234567890" }
  }
}
```

---

### 5. ç”³è¯·é€€æ¬¾
**æ¥å£**ï¼š`cloudfunctions/wxpayFunctions` (type: wxpay_refund)

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "type": "wxpay_refund",
  "outTradeNo": "ORDER_1727699400000_abc123xyz",
  "refundAmount": 36000,
  "reason": "ç”¨æˆ·ç”³è¯·é€€æ¬¾"
}
```

**è¿”å›æ•°æ®**ï¼š
```json
{
  "code": 0,
  "data": {
    "refundId": "50300012345678901234567890",
    "outRefundNo": "REFUND_1727699400000_abc123xyz",
    "status": "SUCCESS"
  }
}
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒé€»è¾‘æ€»ç»“

1. **ä¼šå‘˜ä½“ç³»**ï¼šå…è´¹ç”¨æˆ·ï¼ˆ15æ¡ï¼‰â†’ æ ‡å‡†ä¼šå‘˜ï¼ˆ150æ¡/æœˆï¼‰â†’ é«˜çº§ä¼šå‘˜ï¼ˆ500æ¡/æœˆï¼‰

2. **ä»˜è´¹æ¨¡å¼**ï¼šæŒ‰ç§¯åˆ†è´­ä¹°ï¼Œ1ç§¯åˆ† = 1æ¡æ¶ˆæ¯

3. **æœ‰æ•ˆæœŸç®¡ç†**ï¼š
   - ä¼šå‘˜å¥—é¤ï¼šå»¶é•¿æœ‰æ•ˆæœŸï¼ˆ+30å¤©ï¼‰
   - ç§¯åˆ†åŒ…ï¼šä¸å»¶é•¿æœ‰æ•ˆæœŸ
   - å‡çº§ï¼šä¸æ”¹å˜æœ‰æ•ˆæœŸ

4. **ç»­è´¹çª—å£**ï¼šåˆ°æœŸå‰3å¤©æˆ–åˆ°æœŸåå¯ç»­è´¹

5. **å‡çº§æœºåˆ¶**ï¼šæ ‡å‡†ä¼šå‘˜æœ‰æ•ˆæœŸå†…å¯å‡çº§åˆ°é«˜çº§ï¼Œè¡¥å·®ä»·Â¥215

6. **é™çº§æœºåˆ¶**ï¼šåˆ°æœŸæˆ–é€€æ¬¾åè‡ªåŠ¨é™çº§ä¸ºå…è´¹ç”¨æˆ·

7. **æ”¯ä»˜æµç¨‹**ï¼šä¸‹å• â†’ æ”¯ä»˜ â†’ å›è°ƒ â†’ å…¥è´¦ â†’ è½®è¯¢å…œåº•

---

### ç½‘é¡µç«¯é€‚é…å»ºè®®

1. **æ”¯ä»˜æ–¹å¼**ï¼šä½¿ç”¨å¾®ä¿¡H5æ”¯ä»˜æˆ–æ‰«ç æ”¯ä»˜
2. **å›è°ƒURL**ï¼šé…ç½®ç‹¬ç«‹çš„æ”¯ä»˜å›è°ƒåœ°å€
3. **Sessionç®¡ç†**ï¼šä½¿ç”¨Tokenä»£æ›¿OpenID
4. **UIç»„ä»¶**ï¼šå‚è€ƒå°ç¨‹åºçš„å¡ç‰‡å¼å¥—é¤å±•ç¤º
5. **çŠ¶æ€åŒæ­¥**ï¼šæ”¯ä»˜æˆåŠŸåå®æ—¶åˆ·æ–°ç”¨æˆ·ä¿¡æ¯

---

### æ³¨æ„äº‹é¡¹

âš ï¸ **å®‰å…¨è¦ç‚¹**ï¼š
- æ‰€æœ‰ä»·æ ¼è®¡ç®—åœ¨æœåŠ¡ç«¯å®Œæˆ
- æ”¯ä»˜å›è°ƒå¿…é¡»éªŒè¯ç­¾å
- ç§¯åˆ†æ‰£å‡ä½¿ç”¨æ•°æ®åº“åŸå­æ“ä½œ
- å…³é”®æ“ä½œè®°å½•æ—¥å¿—

âš ï¸ **ç”¨æˆ·ä½“éªŒ**ï¼š
- æ”¯ä»˜è½®è¯¢å…œåº•ç¡®ä¿åˆ°è´¦
- æ˜ç¡®æç¤ºç»­è´¹çª—å£è§„åˆ™
- ç§¯åˆ†ä¸è¶³æ—¶å¼•å¯¼å……å€¼
- åˆ°æœŸå‰3å¤©æé†’ç»­è´¹

âš ï¸ **å¼‚å¸¸å¤„ç†**ï¼š
- æ”¯ä»˜è¶…æ—¶è‡ªåŠ¨å–æ¶ˆè®¢å•
- å›è°ƒå¤±è´¥å¯åŠ¨å¯¹è´¦æœºåˆ¶
- é‡å¤æ”¯ä»˜è‡ªåŠ¨é€€æ¬¾

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-09-30  
**ç»´æŠ¤è€…**ï¼šèµ›æ–¯æ™ºæ…§å¼€å‘å›¢é˜Ÿ

---

å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒï¼š[æ·»åŠ å®¢æœå¾®ä¿¡] 