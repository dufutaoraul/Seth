# 赛斯智慧 - 付费机制完整文档

> 更新时间：2025-09-30
> 适用平台：小程序端 + 网页端通用
> 作者：赛斯智慧团队

---

## 📋 目录

1. [业务模式概述](#业务模式概述)
2. [会员等级体系](#会员等级体系)
3. [付费套餐详情](#付费套餐详情)
4. [积分系统规则](#积分系统规则)
5. [续费与升级逻辑](#续费与升级逻辑)
6. [支付流程](#支付流程)
7. [退款机制](#退款机制)
8. [技术实现要点](#技术实现要点)
9. [数据库设计](#数据库设计)
10. [API接口规范](#api接口规范)

---

## 🎯 业务模式概述

### 核心定位
- **产品形态**：AI智能对话平台（哲学导师赛斯）
- **付费模式**：积分制会员付费
- **计费方式**：按消息数计费（用户发送1条消息 = 消耗1积分）
- **AI回复**：不消耗用户积分

### 商业逻辑
- 免费用户获得15条终身一次性消息额度，用完后必须付费
- 付费用户购买积分包，获得对应数量的消息积分和30天会员有效期
- 积分可叠加，但有效期会重置（每次购买重新计算30天）
- 积分过期后自动降级为免费用户

---

## 👥 会员等级体系

### 1. 免费用户（Free）
**标识**：`userType: 'free'`

**权益**：
- 消息积分：15条（终身一次性，用完不可恢复）
- 最大对话数：3个
- 每日消息上限：10条
- 功能权限：
  - ✅ 基础对话
  - ✅ 历史记录
  - ❌ 高级思维引导
  - ❌ 优先响应

**限制**：
- 15条用完后必须购买积分包才能继续使用
- 无法购买积分补充包（必须先购买会员套餐）

---

### 2. 标准会员（Standard）
**标识**：`userType: 'standard'`

**权益**：
- 消息积分：150条/月
- 最大对话数：20个
- 每日消息上限：100条
- 功能权限：
  - ✅ 基础对话
  - ✅ 历史记录
  - ✅ 高级思维引导
  - ✅ 优先响应
  - ❌ 私人定制对话
  - ❌ 深度哲学探索

**特点**：
- 性价比高，适合轻度用户
- 可在会员有效期内升级到高级会员
- 可购买积分补充包叠加积分

---

### 3. 高级会员（Premium）
**标识**：`userType: 'premium'`

**权益**：
- 消息积分：500条/月
- 最大对话数：无限制
- 每日消息上限：无限制
- 功能权限：
  - ✅ 基础对话
  - ✅ 历史记录
  - ✅ 高级思维引导
  - ✅ 优先响应
  - ✅ 私人定制对话
  - ✅ 深度哲学探索

**特点**：
- 大容量，适合重度用户
- 无限制对话数和每日消息数
- 可购买积分补充包叠加积分

---

## 💰 付费套餐详情

### 套餐类型对照表

| 套餐ID | 套餐名称 | 价格 | 积分数 | 有效期 | 会员等级 | 是否延期 |
|--------|---------|------|--------|--------|----------|----------|
| `standard` | 标准会员 | ¥145 | 150条 | 30天 | standard | ✅ 是 |
| `premium` | 高级会员 | ¥360 | 500条 | 30天 | premium | ✅ 是 |
| `upgrade_to_premium` | 本期升级到高级 | ¥215 | 350条 | - | premium | ❌ 否 |
| `credits150` | 积分补充包150 | ¥145 | 150条 | - | 不变 | ❌ 否 |
| `credits500` | 积分补充包500 | ¥360 | 500条 | - | 不变 | ❌ 否 |

---

### 1️⃣ 标准会员套餐
```json
{
  "id": "standard",
  "type": "standard",
  "title": "标准会员",
  "price": 145,
  "originalPrice": null,
  "credits": 150,
  "validDays": 30,
  "features": [
    "150条消息积分",
    "1个月有效期",
    "积分可叠加",
    "智能对话体验",
    "完整历史记录"
  ]
}
```

**购买效果**：
- 积分：当前积分 + 150
- 有效期：从购买日起重新计算30天（顺延1个月）
- 会员等级：升级为 `standard`

**适用人群**：
- 首次付费用户
- 轻度使用用户
- 预算有限用户

---

### 2️⃣ 高级会员套餐
```json
{
  "id": "premium",
  "type": "premium",
  "title": "高级会员",
  "price": 360,
  "originalPrice": 400,
  "credits": 500,
  "validDays": 30,
  "features": [
    "500条消息积分",
    "1个月有效期",
    "积分可叠加",
    "深度哲学探索",
    "优先响应速度",
    "个性化引导"
  ],
  "popular": true
}
```

**购买效果**：
- 积分：当前积分 + 500
- 有效期：从购买日起重新计算30天（顺延1个月）
- 会员等级：升级为 `premium`

**适用人群**：
- 重度使用用户
- 追求性价比用户
- 需要深度探索用户

**价格优势**：
- 标注"省¥40"（相比购买3次标准会员）
- 单条消息成本：¥0.72/条（标准：¥0.97/条）

---

### 3️⃣ 本期升级到高级会员
```json
{
  "id": "upgrade_to_premium",
  "type": "upgrade",
  "title": "升级到高级会员（本期）",
  "price": 215,
  "credits": 350,
  "validDays": 0
}
```

**购买条件**：
- 当前为标准会员（`userType: 'standard'`）
- 会员有效期内（`creditsExpireDate > 当前时间`）

**购买效果**：
- 积分：当前积分 + 350（补差额至500）
- 有效期：**不改变**（保持原到期时间）
- 会员等级：升级为 `premium`

**价格计算**：
- 补差价：¥360 - ¥145 = ¥215

**适用场景**：
- 标准会员发现150条不够用
- 想要享受高级会员权益
- 不想浪费剩余天数

---

### 4️⃣ 积分补充包

#### 积分包150
```json
{
  "id": "credits150",
  "type": "credits",
  "title": "积分补充包",
  "subtitle": "150积分",
  "price": 145,
  "credits": 150
}
```

#### 积分包500
```json
{
  "id": "credits500",
  "type": "credits",
  "title": "积分补充包",
  "subtitle": "500积分",
  "price": 360,
  "credits": 500
}
```

**购买条件**：
- 必须是会员（`userType: 'standard'` 或 `'premium'`）
- 会员有效期内（`creditsExpireDate > 当前时间`）

**购买效果**：
- 积分：当前积分 + 对应数量
- 有效期：**不改变**（保持原到期时间）
- 会员等级：**不改变**

**适用场景**：
- 会员有效期内积分用完
- 需要更多对话次数
- 不想重置有效期

---

## 🔄 积分系统规则

### 积分获取

#### 1. 注册赠送
- 新用户注册：15条消息积分（终身一次性）
- 积分永久有效（不过期）
- 用完后无法恢复，必须付费购买

#### 2. 购买获得
- 通过微信支付购买积分包
- 积分立即到账
- 可叠加累计

---

### 积分消耗

#### 计费规则
- **用户发送1条消息** = 消耗1积分
- **AI回复** = 不消耗积分
- **扣费时机**：消息发送成功后立即扣减

#### 扣费流程
```javascript
// 1. 检查积分余额
if (user.messageCredits <= 0) {
  return { code: 402, message: 'INSUFFICIENT_CREDITS' }
}

// 2. 检查会员有效期
const isMemberValid = user.creditsExpireDate && 
  new Date(user.creditsExpireDate) > new Date()
if (!isMemberValid && user.userType !== 'free') {
  // 积分已过期，自动降级为免费用户
  user.userType = 'free'
  user.messageCredits = 15
  user.creditsExpireDate = null
}

// 3. 发送消息

// 4. 扣减积分
await db.collection('users').doc(user._id).update({
  messageCredits: user.messageCredits - 1
})
```

#### 余额不足处理
- 提示用户积分不足
- 引导用户前往会员中心充值
- 禁止发送消息

---

### 积分过期

#### 过期规则
- **过期时间**：最后购买日起30天
- **过期字段**：`creditsExpireDate`（ISO 8601格式）
- **计算方式**：每次购买会员套餐时重新计算

#### 过期处理逻辑
```javascript
// 检查积分是否过期
const now = new Date()
const expireDate = new Date(user.creditsExpireDate)

if (expireDate <= now) {
  // 积分已过期，执行降级
  await db.collection('users').doc(user._id).update({
    userType: 'free',
    messageCredits: 15,
    creditsExpireDate: null,
    vipExpiredAt: null
  })
}
```

#### 过期后处理
- 所有积分清零
- 自动降级为免费用户
- 恢复15条免费消息额度
- 会员权益全部失效

---

### 积分叠加规则

#### 会员套餐购买（延长有效期）
```javascript
// 标准会员续费示例
当前状态：
  - 积分：50条
  - 到期：2025-10-15 14:30:00
  
购买标准会员（¥145）：
  - 积分：50 + 150 = 200条
  - 到期：2025-11-15 14:30:00（顺延1个月）
```

#### 积分补充包购买（不延长有效期）
```javascript
// 积分包购买示例
当前状态：
  - 积分：30条
  - 到期：2025-10-15 14:30:00
  
购买积分包150（¥145）：
  - 积分：30 + 150 = 180条
  - 到期：2025-10-15 14:30:00（不变）
```

---

## 🔄 续费与升级逻辑

### 续费窗口规则

#### 续费时机
- **立即可续费情况**：
  1. 会员已过期（`creditsExpireDate <= 当前时间`）
  2. 距离到期不足3天（`剩余天数 <= 3`）
  3. 调试模式强制开启续费窗口（`forceRenew = true`）

- **不可续费情况**：
  1. 距离到期超过3天
  2. 提示："本期会员已生效，临近到期或到期后可续费"

#### 续费按钮状态
```javascript
// 计算是否可以续费
function canRenewMember(vipExpiredAt) {
  if (!vipExpiredAt) return true // 免费用户可购买
  
  const now = new Date()
  const exp = new Date(vipExpiredAt)
  const diffDays = Math.ceil((exp - now) / (24 * 60 * 60 * 1000))
  
  const forceRenew = getStorageSync('forceRenewMember') || false
  const isMemberExpired = exp <= now
  
  return forceRenew || isMemberExpired || diffDays <= 3
}
```

---

### 升级逻辑

#### 标准会员升级到高级会员

**方式一：本期升级（推荐）**
- **价格**：¥215（补差价）
- **积分变化**：当前积分 + 350
- **有效期**：不改变
- **等级**：standard → premium

**触发条件**：
```javascript
// 显示"升级到高级"按钮的条件
const canUpgradeToPremium = 
  currentTier === 'standard' && // 当前是标准会员
  !isMemberExpired // 会员有效期内
```

**升级流程**：
```javascript
// 1. 检查资格
if (currentTier !== 'standard' || isMemberExpired) {
  return { message: '仅标准会员有效期内可升级' }
}

// 2. 创建升级订单
const order = {
  productType: 'upgrade_to_premium',
  amount: 21500, // 215元（单位：分）
  credits: 350
}

// 3. 支付成功后入账
await db.collection('users').doc(userId).update({
  messageCredits: user.messageCredits + 350,
  userType: 'premium',
  // creditsExpireDate 保持不变
})
```

---

**方式二：下期续费时选择高级会员**
- **价格**：¥360
- **积分变化**：当前积分 + 500
- **有效期**：重新计算30天
- **等级**：standard → premium

**适用场景**：
- 当前会员即将到期（<=3天）
- 希望获得更多积分
- 接受重置有效期

---

### 降级逻辑

#### 自动降级触发条件
1. 会员到期（`creditsExpireDate <= 当前时间`）
2. 用户申请退款（退款成功后）

#### 降级处理
```javascript
// 会员到期自动降级
await db.collection('users').doc(userId).update({
  userType: 'free',
  messageCredits: 15,
  creditsExpireDate: null,
  vipExpiredAt: null
})
```

---

## 💳 支付流程

### 用户侧流程

```
选择套餐
   ↓
确认购买（弹窗显示价格和权益）
   ↓
调起微信支付
   ↓
输入密码/指纹/面容
   ↓
支付成功 → 积分立即到账
   ↓
显示购买成功提示
```

---

### 技术侧流程

#### 1. 创建支付订单
**前端调用**：
```javascript
const result = await cloudApi.createPaymentOrder({ 
  productType: 'standard' // 套餐ID
})
```

**云函数处理**：
```javascript
// cloudfunctions/wxpayFunctions/wxpay_order/index.js

// 1. 根据产品类型获取价格
const priceMap = {
  'standard': 14500,        // ¥145
  'premium': 36000,         // ¥360
  'upgrade_to_premium': 21500, // ¥215
  'credits150': 14500,      // ¥145
  'credits500': 36000       // ¥360
}
const totalFee = priceMap[productType]

// 2. 生成订单号
const outTradeNo = `ORDER_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`

// 3. 保存订单到数据库
await db.collection('orders').add({
  data: {
    outTradeNo,
    openId: wxContext.OPENID,
    productType,
    amount: totalFee,
    status: 'pending',
    createdAt: db.serverDate()
  }
})

// 4. 调用微信支付统一下单API
const paymentData = await wxpay.transactions.jsapi({
  description: `赛斯智慧-${productTitle}`,
  out_trade_no: outTradeNo,
  amount: { total: totalFee, currency: 'CNY' },
  payer: { openid: wxContext.OPENID }
})

// 5. 返回支付参数
return {
  code: 0,
  data: {
    timeStamp: String(Date.now()),
    nonceStr: paymentData.nonce_str,
    package: `prepay_id=${paymentData.prepay_id}`,
    signType: 'RSA',
    paySign: paymentData.sign,
    orderId: outTradeNo
  }
}
```

---

#### 2. 调起微信支付
**前端调用**：
```javascript
wx.requestPayment({
  timeStamp: paymentData.timeStamp,
  nonceStr: paymentData.nonceStr,
  package: paymentData.package,
  signType: paymentData.signType,
  paySign: paymentData.paySign,
  success: (res) => {
    console.log('支付成功', res)
    // 刷新用户信息
    loadUserInfo()
  },
  fail: (err) => {
    if (err.errMsg.includes('cancel')) {
      console.log('用户取消支付')
    } else {
      console.error('支付失败', err)
    }
  }
})
```

---

#### 3. 支付回调处理
**微信回调**：
```javascript
// cloudfunctions/payCallback/index.js

exports.main = async (event) => {
  // 1. 验证回调签名（确保来自微信）
  
  // 2. 仅处理支付成功通知
  if (event.event_type !== 'TRANSACTION.SUCCESS') {
    return { code: 0, message: 'IGNORED' }
  }
  
  // 3. 查询订单
  const order = await db.collection('orders')
    .where({ outTradeNo: event.resource.outTradeNo })
    .get()
  
  // 4. 幂等检查（防止重复入账）
  if (order.status === 'paid') {
    return { code: 0, message: 'SUCCESS' }
  }
  
  // 5. 更新订单状态
  await db.collection('orders').doc(order._id).update({
    status: 'paid',
    paidAt: db.serverDate(),
    wxTransactionId: event.resource.transactionId
  })
  
  // 6. 积分入账
  const { credits, validMonths } = mapProductToCredits(order.productType)
  await creditAccountLogic(order.openId, credits, validMonths, order.productType)
  
  return { code: 0, message: 'SUCCESS' }
}
```

---

#### 4. 积分入账逻辑
```javascript
/**
 * 积分入账核心逻辑
 */
async function creditAccountLogic(openId, credits, validMonths, productType) {
  const user = await db.collection('users').where({ _openid: openId }).get()
  const now = new Date()
  
  // 情况1：升级到高级会员（本期）
  if (productType === 'upgrade_to_premium') {
    // 只加积分，不改到期，改等级
    await db.collection('users').doc(user._id).update({
      messageCredits: user.messageCredits + 350,
      userType: 'premium'
      // creditsExpireDate 不变
    })
    return
  }
  
  // 情况2：积分补充包
  if (productType === 'credits150' || productType === 'credits500') {
    // 只加积分，不改到期，不改等级
    await db.collection('users').doc(user._id).update({
      messageCredits: user.messageCredits + credits
      // creditsExpireDate 不变
      // userType 不变
    })
    return
  }
  
  // 情况3：会员套餐（standard/premium）
  // 加积分 + 延长到期 + 改等级
  const currentExpire = user.creditsExpireDate ? 
    new Date(user.creditsExpireDate) : now
  const baseDate = currentExpire > now ? currentExpire : now
  const newExpire = addMonths(baseDate, validMonths)
  
  await db.collection('users').doc(user._id).update({
    messageCredits: user.messageCredits + credits,
    creditsExpireDate: newExpire,
    vipExpiredAt: newExpire,
    userType: productType // 'standard' or 'premium'
  })
}

/**
 * 顺延月份（处理月末边界情况）
 */
function addMonths(baseDate, months) {
  const d = new Date(baseDate)
  const year = d.getFullYear()
  const month = d.getMonth() + months
  const day = d.getDate()
  
  // 计算目标月最后一天
  const lastDayOfTargetMonth = new Date(year, month + 1, 0).getDate()
  const targetDay = Math.min(day, lastDayOfTargetMonth)
  
  return new Date(year, month, targetDay, 
    d.getHours(), d.getMinutes(), d.getSeconds())
}
```

---

#### 5. 兜底轮询机制
为防止支付成功但回调失败导致积分未到账，前端会启动轮询检查：

```javascript
// 前端轮询逻辑
async function startBalanceEnsurePolling(expectedIncrease, orderId) {
  const prePurchaseCredits = currentCredits
  const schedule = [2000, 6000, 12000] // 2s, 8s, 20s后检查
  
  for (let i = 0; i < schedule.length; i++) {
    await sleep(schedule[i] - (schedule[i-1] || 0))
    
    // 刷新用户信息
    await loadUserInfo()
    
    const increased = currentCredits - prePurchaseCredits
    if (increased >= expectedIncrease) {
      showToast('积分已到账')
      return
    }
  }
  
  // 轮询结束仍未到账，调用服务端兜底对账
  await wx.cloud.callFunction({
    name: 'reconcileOrder',
    data: { outTradeNo: orderId }
  })
}
```

---

## 🔙 退款机制

### 退款政策
- **退款期限**：购买后7天内
- **退款条件**：未使用或使用不足10%
- **退款方式**：原路退回微信支付账户
- **到账时间**：1-3个工作日

---

### 退款流程

#### 1. 用户申请退款
```
用户联系客服
   ↓
客服审核资格（购买时间、使用情况）
   ↓
客服在管理后台发起退款
   ↓
微信支付处理退款
   ↓
退款成功 → 扣除积分 + 降级会员
```

---

#### 2. 退款技术实现
```javascript
// 发起退款
const result = await wx.cloud.callFunction({
  name: 'wxpayFunctions',
  data: {
    type: 'wxpay_refund',
    outTradeNo: 'ORDER_XXX',
    refundAmount: 14500,
    reason: '用户申请退款'
  }
})
```

---

#### 3. 退款回调处理
```javascript
// cloudfunctions/refundCallback/index.js

exports.main = async (event) => {
  // 1. 验证回调签名
  
  // 2. 仅处理退款成功通知
  if (event.event_type !== 'REFUND.SUCCESS') {
    return { code: 0, message: 'IGNORED' }
  }
  
  // 3. 查询订单
  const order = await db.collection('orders')
    .where({ outTradeNo: event.resource.outTradeNo })
    .get()
  
  // 4. 更新订单状态
  await db.collection('orders').doc(order._id).update({
    status: 'refunded',
    refundedAt: db.serverDate()
  })
  
  // 5. 扣除积分并降级
  const { credits } = mapProductToCredits(order.productType)
  const user = await db.collection('users')
    .where({ _openid: event.resource.openId })
    .get()
  
  await db.collection('users').doc(user._id).update({
    messageCredits: Math.max(0, user.messageCredits - credits),
    userType: 'free',
    creditsExpireDate: null,
    vipExpiredAt: null
  })
  
  return { code: 0, message: 'SUCCESS' }
}
```

---

## 🛠️ 技术实现要点

### 前端关键点

#### 1. 会员状态判断
```javascript
// 判断会员是否有效
function isMemberValid(user) {
  const expireDate = user.creditsExpireDate
  if (!expireDate) return false
  return new Date(expireDate) > new Date()
}

// 判断是否可以续费
function canRenew(user) {
  const expireDate = user.creditsExpireDate
  if (!expireDate) return true // 免费用户可购买
  
  const now = new Date()
  const exp = new Date(expireDate)
  const diffMs = exp - now
  const diffDays = Math.ceil(diffMs / (24 * 60 * 60 * 1000))
  
  return diffDays <= 3 || exp <= now
}

// 判断是否可以升级到高级
function canUpgrade(user) {
  return user.userType === 'standard' && isMemberValid(user)
}
```

---

#### 2. 按钮状态控制
```javascript
// 套餐选择按钮状态
function getPlanButtonState(plan, user) {
  // 升级到高级按钮
  if (plan.id === 'premium' && canUpgrade(user)) {
    return {
      text: '升级高级',
      disabled: false,
      action: 'upgrade'
    }
  }
  
  // 会员套餐续费按钮
  if (plan.id === 'standard' || plan.id === 'premium') {
    if (!canRenew(user)) {
      return {
        text: '已生效',
        disabled: true
      }
    }
    
    const isCurrentTier = user.userType === plan.type
    return {
      text: isCurrentTier ? '续费' : '选择',
      disabled: false,
      action: 'purchase'
    }
  }
  
  // 积分补充包按钮
  if (plan.type === 'credits') {
    if (!isMemberValid(user)) {
      return {
        text: '需要会员',
        disabled: true
      }
    }
    return {
      text: '购买',
      disabled: false,
      action: 'purchase'
    }
  }
}
```

---

#### 3. 日期格式化
```javascript
/**
 * 格式化日期
 * @param {string|Date} date - 日期
 * @param {number} format - 10:YYYY-MM-DD, 16:YYYY-MM-DD HH:mm
 */
function formatDate(date, format = 10) {
  const d = new Date(date)
  if (isNaN(d.getTime())) return '—'
  
  const year = d.getFullYear()
  const month = String(d.getMonth() + 1).padStart(2, '0')
  const day = String(d.getDate()).padStart(2, '0')
  
  const base = `${year}-${month}-${day}`
  
  if (format === 16) {
    const hour = String(d.getHours()).padStart(2, '0')
    const minute = String(d.getMinutes()).padStart(2, '0')
    return `${base} ${hour}:${minute}`
  }
  
  return base
}
```

---

### 后端关键点

#### 1. 数据库字段设计
```javascript
// users 集合字段
{
  _id: ObjectId,
  _openid: String,          // 微信用户唯一标识
  userType: String,         // 会员类型：'free' | 'standard' | 'premium'
  messageCredits: Number,   // 剩余消息积分
  creditsExpireDate: Date,  // 积分到期时间
  vipExpiredAt: Date,       // 会员到期时间（兼容字段）
  lastPurchaseDate: Date,   // 最后购买时间
  createdAt: Date,          // 注册时间
  updatedAt: Date           // 更新时间
}

// orders 集合字段
{
  _id: ObjectId,
  openId: String,           // 购买用户
  outTradeNo: String,       // 商户订单号
  wxTransactionId: String,  // 微信支付订单号
  productType: String,      // 产品类型：'standard' | 'premium' | ...
  amount: Number,           // 订单金额（单位：分）
  status: String,           // 订单状态：'pending' | 'paid' | 'refunded'
  createdAt: Date,          // 创建时间
  paidAt: Date,             // 支付时间
  refundedAt: Date,         // 退款时间
  updatedAt: Date           // 更新时间
}
```

---

#### 2. 积分扣减（消息发送时）
```javascript
// cloudfunctions/sendMessage/index.js

async function quickCreditCheck(openId) {
  const db = cloud.database()
  const user = await db.collection('users')
    .where({ _openid: openId })
    .get()
  
  if (!user || user.data.length === 0) {
    return null
  }
  
  const userData = user.data[0]
  
  // 检查会员是否过期
  if (userData.creditsExpireDate) {
    const now = new Date()
    const expire = new Date(userData.creditsExpireDate)
    
    if (expire <= now && userData.userType !== 'free') {
      // 会员已过期，自动降级
      await db.collection('users').doc(userData._id).update({
        data: {
          userType: 'free',
          messageCredits: 15,
          creditsExpireDate: null,
          vipExpiredAt: null
        }
      })
      return { ...userData, messageCredits: 15, userType: 'free' }
    }
  }
  
  // 检查积分余额
  if (userData.messageCredits <= 0) {
    return null
  }
  
  return userData
}

async function deductCreditsAsync(openId, requestId) {
  const db = cloud.database()
  
  // 使用原子操作扣减积分
  await db.collection('users')
    .where({ _openid: openId })
    .update({
      data: {
        messageCredits: db.command.inc(-1)
      }
    })
  
  console.log('积分扣减成功:', { openId, requestId })
}
```

---

#### 3. 幂等性保障
```javascript
/**
 * 支付回调幂等性检查
 */
async function handlePaymentCallback(orderNo) {
  const order = await db.collection('orders')
    .where({ outTradeNo: orderNo })
    .get()
  
  // 订单已处理过，直接返回成功
  if (order.data[0].status === 'paid') {
    console.log('订单已处理，跳过:', orderNo)
    return { code: 0, message: 'SUCCESS' }
  }
  
  // 使用数据库事务确保原子性
  const transaction = await db.startTransaction()
  
  try {
    // 1. 更新订单状态
    await transaction.collection('orders')
      .doc(order.data[0]._id)
      .update({ status: 'paid' })
    
    // 2. 积分入账
    await transaction.collection('users')
      .where({ _openid: order.data[0].openId })
      .update({ 
        messageCredits: db.command.inc(credits),
        creditsExpireDate: newExpireDate
      })
    
    // 3. 提交事务
    await transaction.commit()
    
    return { code: 0, message: 'SUCCESS' }
  } catch (error) {
    // 回滚事务
    await transaction.rollback()
    throw error
  }
}
```

---

## 📊 数据库设计

### users 集合
```javascript
{
  _id: "60a1b2c3d4e5f6g7h8i9j0k1",
  _openid: "oABCD1234567890",
  userType: "premium",
  messageCredits: 350,
  creditsExpireDate: "2025-10-30T14:30:00.000Z",
  vipExpiredAt: "2025-10-30T14:30:00.000Z",
  lastPurchaseDate: "2025-09-30T14:30:00.000Z",
  createdAt: "2025-08-01T10:00:00.000Z",
  updatedAt: "2025-09-30T14:30:00.000Z"
}
```

**字段说明**：
- `_openid`：微信用户唯一标识
- `userType`：会员类型（free/standard/premium）
- `messageCredits`：剩余消息积分数
- `creditsExpireDate`：积分到期时间（ISO 8601格式）
- `vipExpiredAt`：会员到期时间（兼容旧版本）
- `lastPurchaseDate`：最后购买时间

---

### orders 集合
```javascript
{
  _id: "70a1b2c3d4e5f6g7h8i9j0k2",
  openId: "oABCD1234567890",
  outTradeNo: "ORDER_1727699400000_abc123xyz",
  wxTransactionId: "4200002312202509301234567890",
  productType: "premium",
  amount: 36000,
  status: "paid",
  createdAt: "2025-09-30T14:30:00.000Z",
  paidAt: "2025-09-30T14:35:00.000Z",
  updatedAt: "2025-09-30T14:35:00.000Z"
}
```

**字段说明**：
- `openId`：购买用户的OpenID
- `outTradeNo`：商户订单号（唯一）
- `wxTransactionId`：微信支付交易号
- `productType`：产品类型（standard/premium/upgrade_to_premium/credits150/credits500）
- `amount`：订单金额（单位：分）
- `status`：订单状态（pending/paid/refunded）

---

### conversations 集合
```javascript
{
  _id: "80a1b2c3d4e5f6g7h8i9j0k3",
  openId: "oABCD1234567890",
  title: "探索意识的本质",
  createdAt: "2025-09-30T10:00:00.000Z",
  updatedAt: "2025-09-30T14:30:00.000Z"
}
```

---

### messages 集合
```javascript
{
  _id: "90a1b2c3d4e5f6g7h8i9j0k4",
  conversationId: "80a1b2c3d4e5f6g7h8i9j0k3",
  content: "什么是意识？",
  isFromUser: true,
  isComplete: true,
  createdAt: "2025-09-30T14:30:00.000Z"
}
```

---

## 🔌 API接口规范

### 1. 用户登录/获取信息
**接口**：`cloudfunctions/login`

**请求参数**：无

**返回数据**：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "_id": "60a1b2c3d4e5f6g7h8i9j0k1",
    "_openid": "oABCD1234567890",
    "userType": "premium",
    "messageCredits": 350,
    "creditsExpireDate": "2025-10-30T14:30:00.000Z",
    "vipExpiredAt": "2025-10-30T14:30:00.000Z"
  }
}
```

---

### 2. 创建支付订单
**接口**：`cloudfunctions/wxpayFunctions` (type: wxpay_order)

**请求参数**：
```json
{
  "type": "wxpay_order",
  "productType": "premium"
}
```

**返回数据**：
```json
{
  "code": 0,
  "data": {
    "timeStamp": "1727699400",
    "nonceStr": "abc123xyz",
    "package": "prepay_id=wx30143005678901234567890",
    "signType": "RSA",
    "paySign": "ABC123XYZ...",
    "orderId": "ORDER_1727699400000_abc123xyz"
  }
}
```

---

### 3. 发送消息
**接口**：`cloudfunctions/sendMessage`

**请求参数**：
```json
{
  "conversationId": "80a1b2c3d4e5f6g7h8i9j0k3",
  "message": "什么是意识？",
  "streaming": true
}
```

**返回数据**：
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "requestId": "req_abc123xyz",
    "messageId": "90a1b2c3d4e5f6g7h8i9j0k4"
  }
}
```

**错误码**：
- `402`：积分不足（INSUFFICIENT_CREDITS）
- `403`：会员已过期（MEMBERSHIP_EXPIRED）

---

### 4. 查询订单
**接口**：`cloudfunctions/wxpayFunctions` (type: wxpay_query_order_by_out_trade_no)

**请求参数**：
```json
{
  "type": "wxpay_query_order_by_out_trade_no",
  "outTradeNo": "ORDER_1727699400000_abc123xyz"
}
```

**返回数据**：
```json
{
  "code": 0,
  "data": {
    "outTradeNo": "ORDER_1727699400000_abc123xyz",
    "transactionId": "4200002312202509301234567890",
    "tradeState": "SUCCESS",
    "amount": { "total": 36000, "currency": "CNY" },
    "payer": { "openid": "oABCD1234567890" }
  }
}
```

---

### 5. 申请退款
**接口**：`cloudfunctions/wxpayFunctions` (type: wxpay_refund)

**请求参数**：
```json
{
  "type": "wxpay_refund",
  "outTradeNo": "ORDER_1727699400000_abc123xyz",
  "refundAmount": 36000,
  "reason": "用户申请退款"
}
```

**返回数据**：
```json
{
  "code": 0,
  "data": {
    "refundId": "50300012345678901234567890",
    "outRefundNo": "REFUND_1727699400000_abc123xyz",
    "status": "SUCCESS"
  }
}
```

---

## 📝 总结

### 核心逻辑总结

1. **会员体系**：免费用户（15条）→ 标准会员（150条/月）→ 高级会员（500条/月）

2. **付费模式**：按积分购买，1积分 = 1条消息

3. **有效期管理**：
   - 会员套餐：延长有效期（+30天）
   - 积分包：不延长有效期
   - 升级：不改变有效期

4. **续费窗口**：到期前3天或到期后可续费

5. **升级机制**：标准会员有效期内可升级到高级，补差价¥215

6. **降级机制**：到期或退款后自动降级为免费用户

7. **支付流程**：下单 → 支付 → 回调 → 入账 → 轮询兜底

---

### 网页端适配建议

1. **支付方式**：使用微信H5支付或扫码支付
2. **回调URL**：配置独立的支付回调地址
3. **Session管理**：使用Token代替OpenID
4. **UI组件**：参考小程序的卡片式套餐展示
5. **状态同步**：支付成功后实时刷新用户信息

---

### 注意事项

⚠️ **安全要点**：
- 所有价格计算在服务端完成
- 支付回调必须验证签名
- 积分扣减使用数据库原子操作
- 关键操作记录日志

⚠️ **用户体验**：
- 支付轮询兜底确保到账
- 明确提示续费窗口规则
- 积分不足时引导充值
- 到期前3天提醒续费

⚠️ **异常处理**：
- 支付超时自动取消订单
- 回调失败启动对账机制
- 重复支付自动退款

---

**文档版本**：v1.0  
**最后更新**：2025-09-30  
**维护者**：赛斯智慧开发团队

---

如有疑问，请联系技术支持：[添加客服微信] 