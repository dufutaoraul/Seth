# 积分负数问题修复指南

## 问题描述

**反馈用户**：bl7309@163.com

**问题表现**：
1. 会员到期后显示 `-181` 积分
2. 充值145元（150积分）后显示 `-31` 积分
3. 无法正常使用对话功能

**根本原因**：
- 会员到期时系统没有自动重置积分（只在用户发送消息时检查）
- 用户访问会员页面和支付回调时也没有检查会员是否过期
- 导致 `used_credits = 181` 保持不变，而充值只增加 `total_credits`
- 结果：`remaining_credits = 150 - 181 = -31`

---

## 一、已修复的代码（已部署）

### 1.1 修复积分显示逻辑 (`app/api/credits/route.ts`)

**修复内容**：每次获取积分信息时，自动检查会员是否过期

```typescript
// ⭐ 检查付费会员是否过期
const now = new Date()
if (userCredits.membership_expires_at && userCredits.current_membership !== '普通会员') {
  const expireDate = new Date(userCredits.membership_expires_at)

  if (expireDate <= now) {
    // 付费会员过期：清零所有积分，重置为15条永久免费积分
    const { data: resetCredits, error: resetError } = await supabaseAdmin
      .from('user_credits')
      .update({
        total_credits: 15,
        used_credits: 0,
        current_membership: '普通会员',
        membership_expires_at: null,
      })
      .eq('user_id', user.id)
      .select()
      .single()

    // 返回重置后的积分
    return resetCredits
  }
}
```

**触发时机**：
- 用户登录后访问聊天页面
- 用户访问会员中心页面

### 1.2 修复支付回调逻辑 (`app/api/payment/notify/route.ts`)

**修复内容**：支付成功前先检查会员是否过期，如果过期则先重置再添加新积分

```typescript
// ⭐ 检查付费会员是否过期，如果过期先重置积分
let baseCredits = currentCredits
const now = new Date()
if (currentCredits.membership_expires_at && currentCredits.current_membership !== '普通会员') {
  const expireDate = new Date(currentCredits.membership_expires_at)

  if (expireDate <= now) {
    // 先重置为15条免费积分
    const { data: resetCredits } = await supabaseAdmin
      .from('user_credits')
      .update({
        total_credits: 15,
        used_credits: 0,
        current_membership: '普通会员',
        membership_expires_at: null,
      })
      .eq('user_id', paymentOrder.user_id)
      .select()
      .single()

    baseCredits = resetCredits
  }
}

// 在重置后的基础上添加新积分
const newTotalCredits = baseCredits.total_credits + paymentOrder.credits_to_add
```

### 1.3 改进管理员后台 (`app/admin/page.tsx`)

**新增功能**：
1. **用户筛选器**
   - 全部用户：显示所有注册用户
   - ⭐ 真实用户：仅显示2025年10月3日之后注册的用户
   - 测试数据：仅显示测试期间的用户

2. **视觉区分**
   - 真实用户行背景色高亮（淡绿色）
   - 真实用户邮箱前显示 ⭐ 标记
   - 筛选按钮显示各类用户数量

3. **统计优化**
   - 统计卡片根据筛选条件动态更新

---

## 二、需要在 Supabase 执行的 SQL（重要！）

### 2.1 修复所有负积分用户（通用修复）

**执行步骤**：
1. 打开 [Supabase Dashboard](https://supabase.com/dashboard)
2. 选择你的项目
3. 点击左侧 **SQL Editor**
4. 点击 **New query**
5. 复制粘贴以下 SQL 并点击 **Run**

```sql
-- 1. 查找所有负积分的用户
SELECT
  u.email,
  uc.total_credits,
  uc.used_credits,
  uc.remaining_credits,
  uc.current_membership,
  uc.membership_expires_at,
  CASE
    WHEN uc.membership_expires_at IS NULL THEN '永久'
    WHEN uc.membership_expires_at < NOW() THEN '已过期'
    ELSE '有效'
  END as membership_status
FROM user_credits uc
JOIN auth.users u ON uc.user_id = u.id
WHERE uc.remaining_credits < 0;

-- 2. 修复已过期会员的负积分（重置为15条免费积分）
UPDATE user_credits
SET
  total_credits = 15,
  used_credits = 0,
  current_membership = '普通会员',
  membership_expires_at = NULL
WHERE remaining_credits < 0
  AND (membership_expires_at IS NULL OR membership_expires_at < NOW());

-- 3. 修复有效会员的负积分（保留总积分，清零已用积分）
UPDATE user_credits
SET
  used_credits = 0
WHERE remaining_credits < 0
  AND membership_expires_at IS NOT NULL
  AND membership_expires_at >= NOW();

-- 4. 验证修复结果（应该返回 0）
SELECT COUNT(*) as negative_credits_count
FROM user_credits
WHERE remaining_credits < 0;
```

### 2.2 专门修复 bl7309@163.com 用户

**执行步骤**：在 SQL Editor 中执行以下 SQL

```sql
-- 1. 查看该用户的当前状态
SELECT
  u.email,
  uc.total_credits,
  uc.used_credits,
  uc.remaining_credits,
  uc.current_membership,
  uc.membership_expires_at,
  CASE
    WHEN uc.membership_expires_at IS NULL THEN '永久'
    WHEN uc.membership_expires_at < NOW() THEN '已过期'
    ELSE '有效'
  END as membership_status
FROM user_credits uc
JOIN auth.users u ON uc.user_id = u.id
WHERE u.email = 'bl7309@163.com';

-- 2. 查看该用户的支付记录
SELECT
  order_no,
  membership_type,
  amount_yuan,
  credits_to_add,
  payment_status,
  paid_at,
  created_at
FROM payment_orders po
JOIN auth.users u ON po.user_id = u.id
WHERE u.email = 'bl7309@163.com'
ORDER BY created_at DESC;

-- 3. 根据会员状态选择修复方案

-- 方案A：如果会员已过期 → 165积分（15免费 + 150充值）
UPDATE user_credits
SET
  total_credits = 165,
  used_credits = 0,
  current_membership = '标准会员',
  membership_expires_at = NOW() + INTERVAL '30 days'
WHERE user_id = (SELECT id FROM auth.users WHERE email = 'bl7309@163.com')
  AND (membership_expires_at IS NULL OR membership_expires_at < NOW());

-- 方案B：如果会员有效 → 150积分（仅充值积分）
UPDATE user_credits
SET
  total_credits = 150,
  used_credits = 0
WHERE user_id = (SELECT id FROM auth.users WHERE email = 'bl7309@163.com')
  AND membership_expires_at IS NOT NULL
  AND membership_expires_at >= NOW();

-- 4. 验证修复结果
SELECT
  u.email,
  uc.total_credits,
  uc.used_credits,
  uc.remaining_credits,
  uc.current_membership,
  uc.membership_expires_at
FROM user_credits uc
JOIN auth.users u ON uc.user_id = u.id
WHERE u.email = 'bl7309@163.com';
```

---

## 三、会员到期积分逻辑说明

### 3.1 正常流程

**场景1：会员到期后不充值**
1. 会员到期（30天后）
2. 用户下次登录访问会员页面 → 自动检测到期
3. 系统清零所有积分：`total_credits = 15, used_credits = 0`
4. 降级为普通会员，赠送15条永久积分

**场景2：会员到期后充值**
1. 会员到期（30天后）
2. 用户充值145元（150积分）
3. 系统先检测到期 → 重置为15条免费积分
4. 然后添加充值积分：`15 + 150 = 165积分`
5. 升级为标准会员，有效期30天

### 3.2 自动检查时机

系统会在以下时机自动检查会员是否过期并重置积分：

1. ✅ **用户登录后访问会员页面** (`/api/credits`)
2. ✅ **用户登录后访问聊天页面** (`/api/credits`)
3. ✅ **用户发送消息时** (`/api/chat-simple`, `/api/chat-stream`)
4. ✅ **用户购买会员时** (`/api/payment/notify`)

**注意**：这是"懒加载检查"机制，不是定时任务。只在用户访问时检查，节省服务器资源。

### 3.3 为什么不用定时任务？

**优点**：
- 不需要运行定时任务，节省服务器成本
- 不需要配置 cron job
- Vercel 等平台对定时任务有限制

**缺点**：
- 如果用户长期不登录，过期状态不会立即更新

**结论**：对于你的场景完全够用，因为用户下次登录时一定会自动处理。

---

## 四、操作清单

### ✅ 步骤1：等待 Vercel 部署完成（1-2分钟）

代码已推送到 GitHub，Vercel 会自动部署。

访问：https://vercel.com/dashboard 查看部署状态

### ⚠️ 步骤2：在 Supabase 执行修复 SQL（必须做！）

1. 先执行 `2.1 修复所有负积分用户` 的 SQL
2. 再执行 `2.2 专门修复 bl7309@163.com 用户` 的 SQL

### ✅ 步骤3：通知用户刷新页面

让 bl7309@163.com 用户：
1. 刷新浏览器（Ctrl+F5 清除缓存）
2. 重新登录
3. 访问会员中心

**预期结果**：
- 如果会员已过期：显示 **165 积分**（15免费 + 150充值）
- 如果会员有效：显示 **150 积分**（充值积分）

### ✅ 步骤4：查看改进后的管理后台

访问：https://seth-blush.vercel.app/admin

**新功能**：
- 点击 "⭐ 真实用户" 按钮，只显示2025年10月3日后注册的用户
- 真实用户会有绿色背景和⭐标记
- 统计数据会根据筛选自动更新

---

## 五、常见问题

### Q1：会员到期后，原来的积分会保留吗？

**答**：不会。会员到期后，所有剩余积分会清零，系统赠送15条永久有效的免费积分。

### Q2：用户充值后应该有多少积分？

**答**：
- 如果会员已过期：**15（免费）+ 150（充值）= 165积分**
- 如果会员有效：**150积分**（直接累加）

### Q3：如何确认会员是否过期？

**答**：在 Supabase SQL Editor 中执行：

```sql
SELECT
  email,
  current_membership,
  membership_expires_at,
  CASE
    WHEN membership_expires_at IS NULL THEN '永久'
    WHEN membership_expires_at < NOW() THEN '已过期'
    ELSE '有效'
  END as status
FROM user_credits uc
JOIN auth.users u ON uc.user_id = u.id
WHERE u.email = 'bl7309@163.com';
```

### Q4：修复SQL会影响其他用户吗？

**答**：不会。修复SQL只针对 `remaining_credits < 0` 的用户，不会影响正常用户。

---

## 六、技术总结

### 修复前的问题

```
会员到期：
total_credits = 331 (之前累积的)
used_credits = 181
remaining_credits = 150

用户看到：150积分（正常）

但实际会员已过期，应该清零！

用户充值150积分：
total_credits = 331 + 150 = 481
used_credits = 181 (没有清零！)
remaining_credits = 481 - 181 = 300

BUT！系统某处可能触发了过期检查：
total_credits = 0 (清零)
used_credits = 181 (没有同步清零！)
remaining_credits = 0 - 181 = -181

用户看到：-181积分 ❌

再充值150积分：
total_credits = 0 + 150 = 150
used_credits = 181 (还是没清零！)
remaining_credits = 150 - 181 = -31

用户看到：-31积分 ❌
```

### 修复后的逻辑

```
会员到期时（用户访问会员页面）：
1. 检测到会员已过期
2. 重置：total_credits = 15, used_credits = 0
3. 用户看到：15积分 ✅

用户充值150积分：
1. 检测到会员已过期
2. 先重置：total_credits = 15, used_credits = 0
3. 再添加：total_credits = 15 + 150 = 165
4. 用户看到：165积分 ✅
```

---

## 七、联系信息

如有问题，请联系：
- 客服微信：15692903143
- 技术支持：通过 GitHub Issues 反馈

---

**最后更新时间**：2025-11-04
**修复版本**：v2.0
**状态**：✅ 已修复并部署
