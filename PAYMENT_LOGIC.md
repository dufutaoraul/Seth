# ä¸èµ›æ–¯å¯¹è¯ - ç½‘é¡µç«¯ä»˜è´¹é€»è¾‘æ–‡æ¡£

> æ›´æ–°æ—¶é—´ï¼š2025-10-01
> ç‰ˆæœ¬ï¼šv2.0ï¼ˆä¿®æ­£ç‰ˆï¼‰
> ä½œè€…ï¼šèµ›æ–¯æ™ºæ…§å›¢é˜Ÿ

---

## ğŸ“‹ æ ¸å¿ƒé€»è¾‘æ€»ç»“

### å…è´¹ç§¯åˆ†è§„åˆ™ï¼ˆé‡è¦ä¿®æ­£ï¼‰

**æ–°ç”¨æˆ·æ³¨å†Œï¼š**
- èµ é€ **15æ¡å…è´¹ç§¯åˆ†**
- **æ°¸ä¹…æœ‰æ•ˆ**ï¼ˆä¸ä¼šè¿‡æœŸï¼Œä¸ä¼šé‡ç½®ï¼‰
- ç”¨å®Œä¸ºæ­¢ï¼Œä¸ä¼šæ¯æœˆé‡ç½®

**ä»˜è´¹ä¼šå‘˜è¿‡æœŸæ—¶ï¼š**
- é™çº§ä¸ºæ™®é€šä¼šå‘˜
- **å†æ¬¡èµ é€15æ¡å…è´¹ç§¯åˆ†**ï¼ˆåœ¨ç°æœ‰ç§¯åˆ†åŸºç¡€ä¸Š+15ï¼‰
- è¿™15æ¡ç§¯åˆ†åŒæ ·**æ°¸ä¹…æœ‰æ•ˆ**

**é‡è¦è¯´æ˜ï¼š**
- âŒ æ²¡æœ‰"æ¯æœˆé‡ç½®15ç§¯åˆ†"çš„é€»è¾‘
- âŒ å…è´¹ç”¨æˆ·ä¸ä¼šå®šæœŸè·å¾—ç§¯åˆ†
- âœ… å…è´¹ç§¯åˆ†åªåœ¨ä¸¤ç§æƒ…å†µä¸‹èµ é€ï¼šæ–°ç”¨æˆ·æ³¨å†Œ & ä»˜è´¹ä¼šå‘˜è¿‡æœŸ

---

## ğŸ‘¥ ä¼šå‘˜ç­‰çº§ä½“ç³»

### 1. æ™®é€šä¼šå‘˜ï¼ˆå…è´¹ç”¨æˆ·ï¼‰
**æ•°æ®åº“æ ‡è¯†**ï¼š`current_membership: 'æ™®é€šä¼šå‘˜'`

**æƒç›Šï¼š**
- æ–°æ³¨å†Œèµ é€ï¼š15æ¡æ°¸ä¹…ç§¯åˆ†
- ä»˜è´¹ä¼šå‘˜åˆ°æœŸèµ é€ï¼š15æ¡æ°¸ä¹…ç§¯åˆ†
- **æ— æœ‰æ•ˆæœŸé™åˆ¶**
- ç”¨å®Œéœ€è´­ä¹°ä¼šå‘˜å¥—é¤

**æ•°æ®åº“å­—æ®µï¼š**
```javascript
{
  current_membership: 'æ™®é€šä¼šå‘˜',
  total_credits: 15,
  used_credits: 0,
  membership_expires_at: null  // å…è´¹ç§¯åˆ†æ°¸ä¹…æœ‰æ•ˆ
}
```

---

### 2. æ ‡å‡†ä¼šå‘˜
**æ•°æ®åº“æ ‡è¯†**ï¼š`current_membership: 'æ ‡å‡†ä¼šå‘˜'`

**æƒç›Šï¼š**
- æµ‹è¯•ä»·æ ¼ï¼šÂ¥1 / 3ç§¯åˆ†
- æ­£å¼ä»·æ ¼ï¼šÂ¥145 / 150ç§¯åˆ†
- æœ‰æ•ˆæœŸï¼š30å¤©
- å¯å åŠ è´­ä¹°

**æ•°æ®åº“å­—æ®µï¼š**
```javascript
{
  current_membership: 'æ ‡å‡†ä¼šå‘˜',
  total_credits: 15 + 3,  // åŸæœ‰ç§¯åˆ† + æ–°è´­ä¹°ç§¯åˆ†
  used_credits: 0,
  membership_expires_at: '2025-10-31T00:00:00Z'  // 30å¤©å
}
```

---

### 3. é«˜çº§ä¼šå‘˜
**æ•°æ®åº“æ ‡è¯†**ï¼š`current_membership: 'é«˜çº§ä¼šå‘˜'`

**æƒç›Šï¼š**
- æµ‹è¯•ä»·æ ¼ï¼šÂ¥2 / 6ç§¯åˆ†
- æ­£å¼ä»·æ ¼ï¼šÂ¥360 / 500ç§¯åˆ†
- æœ‰æ•ˆæœŸï¼š30å¤©
- å¯å åŠ è´­ä¹°

**åŠŸèƒ½è¯´æ˜ï¼š**
- **æ³¨æ„**ï¼šé«˜çº§ä¼šå‘˜çš„"é«˜çº§æ€ç»´å¼•å¯¼"ã€"ä¼˜å…ˆå“åº”"ç­‰åŠŸèƒ½ä»…ä¸ºè¥é”€æè¿°
- å®é™…ä½¿ç”¨çš„AIæœåŠ¡ä¸æ ‡å‡†ä¼šå‘˜å®Œå…¨ç›¸åŒ
- å·®å¼‚ä»…åœ¨äºç§¯åˆ†æ•°é‡å’Œä»·æ ¼

---

## ğŸ›’ è®¢å•ç±»å‹

### 1. ä¼šå‘˜å¥—é¤ï¼ˆmembershipï¼‰
**é€‚ç”¨åœºæ™¯ï¼š**
- å…è´¹ç”¨æˆ·é¦–æ¬¡è´­ä¹°
- ä»˜è´¹ä¼šå‘˜ç»­è´¹
- æ ‡å‡†ä¼šå‘˜è´­ä¹°æ ‡å‡†å¥—é¤
- é«˜çº§ä¼šå‘˜è´­ä¹°é«˜çº§å¥—é¤

**é€»è¾‘ï¼š**
```javascript
{
  order_type: 'membership',
  membership_type: 'æ ‡å‡†ä¼šå‘˜' | 'é«˜çº§ä¼šå‘˜',
  // å¤„ç†é€»è¾‘ï¼š
  // 1. å¢åŠ ç§¯åˆ†ï¼ˆç´¯åŠ ï¼‰
  // 2. æ›´æ–°ä¼šå‘˜ç­‰çº§
  // 3. å»¶é•¿æœ‰æ•ˆæœŸ30å¤©ï¼ˆä»å½“å‰åˆ°æœŸæ—¥æˆ–å½“å‰æ—¶é—´å¼€å§‹è®¡ç®—ï¼‰
}
```

**æœ‰æ•ˆæœŸè®¡ç®—ï¼š**
```javascript
const now = new Date()
const currentExpiry = user.membership_expires_at
  ? new Date(user.membership_expires_at)
  : now

// å¦‚æœè¿˜æ²¡è¿‡æœŸï¼Œä»åˆ°æœŸæ—¶é—´å»¶é•¿ï¼›å¦åˆ™ä»ç°åœ¨å¼€å§‹
const startDate = currentExpiry > now ? currentExpiry : now
const newExpiry = new Date(startDate.getTime() + 30 * 24 * 60 * 60 * 1000)
```

---

### 2. å‡çº§å¥—é¤ï¼ˆupgradeï¼‰
**é€‚ç”¨åœºæ™¯ï¼š**
- æ ‡å‡†ä¼šå‘˜å‡çº§åˆ°é«˜çº§ä¼šå‘˜

**é€»è¾‘ï¼š**
```javascript
{
  order_type: 'upgrade',
  // å¤„ç†é€»è¾‘ï¼š
  // 1. å¢åŠ ç§¯åˆ†ï¼ˆè¡¥å·®é¢ï¼‰
  // 2. æ›´æ–°ä¼šå‘˜ç­‰çº§ä¸º"é«˜çº§ä¼šå‘˜"
  // 3. âš ï¸ ä¸å»¶é•¿æœ‰æ•ˆæœŸï¼ˆä½¿ç”¨åŸæœ‰åˆ°æœŸæ—¶é—´ï¼‰
}
```

**è¯´æ˜ï¼š**
- å‡çº§ä»…æ”¹å˜ç­‰çº§ï¼Œä¸é‡ç½®30å¤©
- ç§¯åˆ†è¡¥å·®ï¼šé«˜çº§(6ç§¯åˆ†) - æ ‡å‡†(3ç§¯åˆ†) = 3ç§¯åˆ†å·®é¢

---

### 3. ç§¯åˆ†åŒ…ï¼ˆcredit_packï¼‰
**é€‚ç”¨åœºæ™¯ï¼š**
- ä»˜è´¹ä¼šå‘˜æƒ³å¢åŠ ç§¯åˆ†ä½†ä¸å»¶é•¿æœ‰æ•ˆæœŸ

**é€»è¾‘ï¼š**
```javascript
{
  order_type: 'credit_pack',
  // å¤„ç†é€»è¾‘ï¼š
  // 1. ä»…å¢åŠ ç§¯åˆ†
  // 2. ä¸æ”¹å˜ä¼šå‘˜ç­‰çº§
  // 3. ä¸æ”¹å˜æœ‰æ•ˆæœŸ
}
```

---

## â° ä¼šå‘˜è¿‡æœŸå¤„ç†

### æ£€æŸ¥æ—¶æœº
æ¯æ¬¡ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶æ£€æŸ¥ï¼ˆ`/api/chat-simple/route.ts`ï¼‰

### è¿‡æœŸé€»è¾‘
```javascript
// åªæ£€æŸ¥ä»˜è´¹ä¼šå‘˜æ˜¯å¦è¿‡æœŸ
if (user.membership_expires_at && user.current_membership !== 'æ™®é€šä¼šå‘˜') {
  const expireDate = new Date(user.membership_expires_at)
  const now = new Date()

  if (expireDate <= now) {
    // ä»˜è´¹ä¼šå‘˜è¿‡æœŸå¤„ç†ï¼š
    await db.update({
      total_credits: user.total_credits + 15,  // åœ¨ç°æœ‰ç§¯åˆ†åŸºç¡€ä¸Š+15
      current_membership: 'æ™®é€šä¼šå‘˜',
      membership_expires_at: null,  // æ¸…é™¤è¿‡æœŸæ—¶é—´ï¼Œå…è´¹ç§¯åˆ†æ°¸ä¹…æœ‰æ•ˆ
    })
  }
}
```

### è¿‡æœŸç¤ºä¾‹
**ç”¨æˆ·Aè´­ä¹°æ ‡å‡†ä¼šå‘˜ï¼š**
```javascript
// è´­ä¹°å‰ï¼ˆå…è´¹ç”¨æˆ·ï¼‰
{ total_credits: 15, used_credits: 5, current_membership: 'æ™®é€šä¼šå‘˜', membership_expires_at: null }

// è´­ä¹°åï¼ˆæ ‡å‡†ä¼šå‘˜ï¼‰
{ total_credits: 10 + 3 = 13, used_credits: 5, current_membership: 'æ ‡å‡†ä¼šå‘˜', membership_expires_at: '2025-10-31' }

// 30å¤©åè¿‡æœŸï¼ˆè‡ªåŠ¨é™çº§ï¼‰
{ total_credits: 13 + 15 = 28, used_credits: 5, current_membership: 'æ™®é€šä¼šå‘˜', membership_expires_at: null }
```

**ç”¨æˆ·Bæ˜¯é«˜çº§ä¼šå‘˜ï¼Œç§¯åˆ†ç”¨å®Œåè¿‡æœŸï¼š**
```javascript
// è¿‡æœŸå‰ï¼ˆç§¯åˆ†å·²ç”¨å®Œï¼‰
{ total_credits: 500, used_credits: 500, current_membership: 'é«˜çº§ä¼šå‘˜', membership_expires_at: '2025-10-31' }

// è¿‡æœŸå
{ total_credits: 500 + 15 = 515, used_credits: 500, current_membership: 'æ™®é€šä¼šå‘˜', membership_expires_at: null }
// å‰©ä½™å¯ç”¨ç§¯åˆ†ï¼š515 - 500 = 15æ¡
```

---

## ğŸ’³ æ”¯ä»˜æµç¨‹

### 1. åˆ›å»ºè®¢å•ï¼ˆ`/api/payment/create`ï¼‰
```javascript
POST /api/payment/create
{
  "productType": "æ ‡å‡†ä¼šå‘˜" | "é«˜çº§ä¼šå‘˜" | "å‡çº§åˆ°é«˜çº§" | "ç§¯åˆ†åŒ…150" | "ç§¯åˆ†åŒ…500",
  "paymentType": "alipay" | "wxpay"
}

Response:
{
  "orderNo": "20251001123456789",
  "paymentUrl": "https://zpay.example.com/...",
  "amount": 1.00,
  "productName": "æ ‡å‡†ä¼šå‘˜"
}
```

### 2. æ”¯ä»˜å›è°ƒï¼ˆ`/api/payment/notify`ï¼‰
```javascript
GET /api/payment/notify?out_trade_no=xxx&trade_no=xxx&money=1.00&sign=xxx

å¤„ç†æµç¨‹ï¼š
1. éªŒè¯ç­¾å
2. æŸ¥æ‰¾è®¢å•
3. æ£€æŸ¥è®¢å•çŠ¶æ€ï¼ˆé˜²æ­¢é‡å¤å¤„ç†ï¼‰
4. æ›´æ–°è®¢å•çŠ¶æ€ä¸º"paid"
5. æ ¹æ®order_typeæ›´æ–°ç”¨æˆ·ç§¯åˆ†å’Œä¼šå‘˜ç­‰çº§
6. è¿”å›"success"
```

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### user_credits è¡¨
```sql
CREATE TABLE user_credits (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  total_credits INTEGER DEFAULT 15,           -- æ€»ç§¯åˆ†
  used_credits INTEGER DEFAULT 0,             -- å·²ä½¿ç”¨ç§¯åˆ†
  current_membership TEXT DEFAULT 'æ™®é€šä¼šå‘˜',  -- å½“å‰ä¼šå‘˜ç­‰çº§
  membership_expires_at TIMESTAMPTZ,          -- ä¼šå‘˜åˆ°æœŸæ—¶é—´ï¼ˆå…è´¹ç”¨æˆ·ä¸ºnullï¼‰
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### payment_orders è¡¨
```sql
CREATE TABLE payment_orders (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  order_no TEXT UNIQUE,                       -- è®¢å•å·
  order_type TEXT,                            -- 'membership' | 'upgrade' | 'credit_pack'
  membership_type TEXT,                       -- 'æ ‡å‡†ä¼šå‘˜' | 'é«˜çº§ä¼šå‘˜' | null
  product_name TEXT,                          -- å•†å“åç§°
  amount DECIMAL(10,2),                       -- æ”¯ä»˜é‡‘é¢
  credits_to_add INTEGER,                     -- è¦å¢åŠ çš„ç§¯åˆ†
  payment_status TEXT DEFAULT 'pending',      -- 'pending' | 'paid' | 'failed'
  zpay_trade_no TEXT,                         -- ZPayäº¤æ˜“å·
  zpay_response JSONB,                        -- ZPayå›è°ƒåŸå§‹æ•°æ®
  paid_at TIMESTAMPTZ,                        -- æ”¯ä»˜æ—¶é—´
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. é˜²æ­¢é‡å¤æ‰£ç§¯åˆ†
```javascript
// ä½¿ç”¨ç®¡ç†å‘˜æƒé™çš„Supabaseå®¢æˆ·ç«¯ï¼Œç»•è¿‡RLS
const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
)

// ç¡®ä¿ç§¯åˆ†æ›´æ–°çš„åŸå­æ€§
await supabaseAdmin
  .from('user_credits')
  .update({ used_credits: user.used_credits + 1 })
  .eq('user_id', user.id)
```

### 2. ä¼šå‘˜è¿‡æœŸè‡ªåŠ¨å¤„ç†
```javascript
// æ¯æ¬¡èŠå¤©æ—¶æ£€æŸ¥ï¼Œæ— éœ€å®šæ—¶ä»»åŠ¡
// åªæ£€æŸ¥ä»˜è´¹ä¼šå‘˜ï¼Œå…è´¹ç”¨æˆ·æ°¸ä¸è¿‡æœŸ
if (user.membership_expires_at && user.current_membership !== 'æ™®é€šä¼šå‘˜') {
  // æ£€æŸ¥å¹¶å¤„ç†è¿‡æœŸ
}
```

### 3. æ”¯ä»˜å›è°ƒå¹‚ç­‰æ€§
```javascript
// æ£€æŸ¥è®¢å•æ˜¯å¦å·²å¤„ç†
if (order.payment_status === 'paid') {
  return new Response('success')  // ç›´æ¥è¿”å›æˆåŠŸï¼Œé¿å…é‡å¤å¤„ç†
}
```

---

## ğŸ¯ æµ‹è¯•ä»·æ ¼ vs æ­£å¼ä»·æ ¼

### å½“å‰ï¼ˆæµ‹è¯•é˜¶æ®µï¼‰
```javascript
export const MEMBERSHIP_PLANS = {
  'æ ‡å‡†ä¼šå‘˜': { credits: 3, price: 1 },   // Â¥1 / 3ç§¯åˆ†
  'é«˜çº§ä¼šå‘˜': { credits: 6, price: 2 },   // Â¥2 / 6ç§¯åˆ†
}
```

### ä¸Šçº¿åï¼ˆæ­£å¼ä»·æ ¼ï¼‰
```javascript
export const MEMBERSHIP_PLANS = {
  'æ ‡å‡†ä¼šå‘˜': { credits: 150, price: 145 },   // Â¥145 / 150ç§¯åˆ†
  'é«˜çº§ä¼šå‘˜': { credits: 500, price: 360 },   // Â¥360 / 500ç§¯åˆ†
}
```

**ä¸Šçº¿å‰ä¿®æ”¹ä½ç½®ï¼š** `lib/zpay.ts:104-109`

---

## â“ å¸¸è§é—®é¢˜

### Q1: å…è´¹ç”¨æˆ·çš„15ç§¯åˆ†ä¼šè¿‡æœŸå—ï¼Ÿ
**A:** ä¸ä¼šï¼å…è´¹ç§¯åˆ†æ°¸ä¹…æœ‰æ•ˆï¼Œç”¨å®Œä¸ºæ­¢ã€‚

### Q2: ä»˜è´¹ä¼šå‘˜è¿‡æœŸåï¼ŒåŸæœ‰å‰©ä½™ç§¯åˆ†ä¼šæ¸…é›¶å—ï¼Ÿ
**A:** ä¸ä¼šï¼è¿‡æœŸæ—¶ä¼šåœ¨åŸæœ‰ç§¯åˆ†åŸºç¡€ä¸Š+15ï¼Œæ‰€æœ‰ç§¯åˆ†æ°¸ä¹…æœ‰æ•ˆã€‚

### Q3: ä¸ºä»€ä¹ˆé«˜çº§ä¼šå‘˜æ²¡æœ‰ç‰¹æ®ŠåŠŸèƒ½ï¼Ÿ
**A:** é«˜çº§ä¼šå‘˜çš„"é«˜çº§æ€ç»´å¼•å¯¼"ç­‰åŠŸèƒ½ä»…ä¸ºè¥é”€è¯æœ¯ï¼Œå®é™…AIæœåŠ¡ä¸æ ‡å‡†ä¼šå‘˜ç›¸åŒï¼Œå·®å¼‚ä»…åœ¨ç§¯åˆ†æ•°é‡ã€‚

### Q4: ç»­è´¹æ—¶æœ‰æ•ˆæœŸå¦‚ä½•è®¡ç®—ï¼Ÿ
**A:** å¦‚æœè¿˜æ²¡è¿‡æœŸï¼Œä»åˆ°æœŸæ—¶é—´å»¶é•¿30å¤©ï¼›å¦‚æœå·²è¿‡æœŸï¼Œä»è´­ä¹°æ—¶é—´å»¶é•¿30å¤©ã€‚

### Q5: ç§¯åˆ†åŒ…å’Œä¼šå‘˜å¥—é¤çš„åŒºåˆ«ï¼Ÿ
**A:** ä¼šå‘˜å¥—é¤ä¼šå»¶é•¿30å¤©æœ‰æ•ˆæœŸï¼Œç§¯åˆ†åŒ…ä¸ä¼šå»¶é•¿æœ‰æ•ˆæœŸï¼Œåªå¢åŠ ç§¯åˆ†ã€‚

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v2.0 (2025-10-01)
- **é‡å¤§ä¿®æ­£**ï¼šåˆ é™¤å…è´¹ç”¨æˆ·30å¤©é‡ç½®é€»è¾‘
- å…è´¹ç§¯åˆ†æ”¹ä¸ºæ°¸ä¹…æœ‰æ•ˆ
- ä»˜è´¹ä¼šå‘˜è¿‡æœŸæ—¶èµ é€15æ¡æ°¸ä¹…ç§¯åˆ†
- ç®€åŒ–è¿‡æœŸæ£€æŸ¥é€»è¾‘

### v1.0 (2025-09-30)
- åˆå§‹ç‰ˆæœ¬
- å®ç°ä¼šå‘˜å¥—é¤ã€å‡çº§ã€ç§¯åˆ†åŒ…ä¸‰ç§è®¢å•ç±»å‹
- å®ç°ZPayæ”¯ä»˜é›†æˆ
